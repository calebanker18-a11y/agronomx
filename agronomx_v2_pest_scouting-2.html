<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AgronomX - Farm Management</title>
  <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
  <script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
  <script src='https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js'></script>
  <script src="https://unpkg.com/shpjs@latest/dist/shp.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Exo 2', sans-serif; background: #f5f5f5; }
    .header { padding: 20px; text-align: center; border-bottom: 1px solid #e0e0e0; background: white; }
    .header img { height: 60px; }
    .container { max-width: 1400px; margin: 0 auto; padding: 30px 20px; }
    .btn { padding: 14px 24px; background: #4CAF50; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; font-family: 'Exo 2', sans-serif; }
    .btn:hover { background: #45a049; }
    .btn-secondary { background: #2196F3; }
    .btn-secondary:hover { background: #1976D2; }
    .btn-danger { background: #f44336; }
    .btn-danger:hover { background: #d32f2f; }
    .btn-warning { background: #FF9800; }
    .btn-warning:hover { background: #F57C00; }
    .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 40px; }
    .stat-card { padding: 30px; border-radius: 16px; color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
    .stat-card h3 { font-size: 48px; font-weight: 700; margin: 8px 0; }
    .stat-card p { font-size: 16px; opacity: 0.9; }
    .stat-label { font-size: 14px; opacity: 0.9; margin-bottom: 8px; font-weight: 500; }
    .action-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 40px; }
    .action-btn { padding: 20px; border-radius: 12px; font-size: 18px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; margin-bottom: 8px; font-size: 14px; font-weight: 500; color: #555; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; font-family: 'Exo 2', sans-serif; }
    .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px; }
    .field-card, .product-card { background: #f9f9f9; padding: 20px; border-radius: 12px; border-left: 4px solid #4CAF50; margin-bottom: 15px; }
    .menu { position: relative; display: inline-block; }
    .menu-btn { background: none; border: none; font-size: 20px; cursor: pointer; padding: 5px 10px; }
    .menu-content { display: none; position: absolute; right: 0; background: white; border: 1px solid #ddd; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); z-index: 10; min-width: 120px; }
    .menu-content.show { display: block; }
    .menu-item { padding: 10px 15px; cursor: pointer; border-bottom: 1px solid #f0f0f0; }
    .menu-item:hover { background: #f5f5f5; }
    .menu-item.danger { color: #d32f2f; }
    .menu-item.danger:hover { background: #ffebee; }
    .suggestion-box { position: absolute; background: white; border: 1px solid #ddd; border-radius: 6px; max-height: 300px; overflow-y: auto; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 10; width: 100%; margin-top: 4px; }
    .suggestion-item { padding: 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0; }
    .suggestion-item:hover { background: #f5f5f5; }
    .hidden { display: none; }
    
    /* Map styles */
    #map { width: 100%; height: 500px; border-radius: 12px; margin-bottom: 20px; }
    .map-controls { position: absolute; top: 10px; left: 10px; z-index: 1; display: flex; flex-direction: column; gap: 10px; }
    .map-info { position: absolute; top: 10px; right: 10px; z-index: 1; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); min-width: 200px; }
    .map-info h4 { margin-bottom: 10px; font-size: 16px; color: #333; }
    .map-info .acres { font-size: 32px; font-weight: 700; color: #4CAF50; margin: 10px 0; }
    .map-info .points { font-size: 14px; color: #666; }
  </style>
</head>
<body>
  <div class="header">
    <img src="https://i.imgur.com/KtJ8tMD.png" alt="AgronomX" style="height: 60px;">
  </div>

  <!-- Login Screen -->
  <div id="loginScreen" class="container" style="max-width: 400px; margin-top: 60px;">
    <h1 style="font-size: 32px; font-weight: 600; color: #333; text-align: center; margin-bottom: 40px;">Welcome Back</h1>
    <div class="form-group">
      <label>Email</label>
      <input type="email" id="loginEmail" placeholder="you@farm.com">
    </div>
    <div class="form-group">
      <label>Password</label>
      <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
    </div>
    <button class="btn" style="width: 100%;" onclick="login()">Log In</button>
  </div>

  <!-- Dashboard Screen -->
  <div id="dashboardScreen" class="container hidden">
    <h1 style="font-size: 36px; font-weight: 700; color: #333; margin-bottom: 10px;">Dashboard</h1>
    <p style="color: #666; margin-bottom: 30px; font-size: 16px;">Welcome back! Here's your farm overview.</p>

    <div class="stat-grid">
      <div class="stat-card" style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);">
        <div class="stat-label">üåæ Total Fields</div>
        <h3 id="statFields">0</h3>
        <p id="statAcres">Add your first field</p>
      </div>
      <div class="stat-card" id="statProfitCard" style="background: linear-gradient(135deg, #9E9E9E 0%, #757575 100%);">
        <div class="stat-label">üí∞ Net Profit</div>
        <h3 id="statProfit">‚Äî</h3>
        <p id="statROI">Log harvest to see profit</p>
      </div>
      <div class="stat-card" style="background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);">
        <div class="stat-label">üìä Total Expenses</div>
        <h3 id="statExpenses">$0</h3>
        <p id="statExpensesPerAcre">Start logging activities</p>
      </div>
      <div class="stat-card" style="background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);" id="weatherCard">
        <div class="stat-label">üå§Ô∏è Local Weather</div>
        <h3 id="weatherTemp">--¬∞F</h3>
        <p id="weatherCondition">Loading weather...</p>
        <button onclick="showLocationSettings()" style="margin-top: 10px; padding: 6px 12px; background: rgba(255,255,255,0.2); border: 1px solid white; border-radius: 6px; color: white; cursor: pointer; font-size: 12px; font-family: 'Exo 2', sans-serif;">üìç Set Location</button>
      </div>
    </div>

    <!-- Quick Actions -->
    <h2 style="font-size: 24px; font-weight: 600; color: #333; margin: 30px 0 20px;">Quick Actions</h2>
    <div class="action-grid" style="margin-bottom: 40px;">
      <button class="btn action-btn" onclick="showScreen('log')">üìù Log Activity</button>
      <button class="btn btn-secondary action-btn" onclick="showScreen('fields')">üåæ Manage Fields</button>
      <button class="btn action-btn" style="background: #FF5722;" onclick="showScreen('scouting')">üåø Crop Scouting</button>
      <button class="btn action-btn" style="background: #9C27B0;" onclick="showScreen('inventory')">üì¶ Inventory</button>
      <button class="btn action-btn" style="background: #667eea;" onclick="showScreen('operation')">üìä My Operation</button>
    </div>

    <!-- Location Settings Modal -->
    <div id="locationModal" class="hidden" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: none; align-items: center; justify-content: center;" onclick="closeLocationSettings()">
      <div style="background: white; padding: 30px; border-radius: 16px; max-width: 500px; width: 90%; box-shadow: 0 8px 32px rgba(0,0,0,0.3);" onclick="event.stopPropagation()">
        <h2 style="margin-bottom: 20px; font-size: 24px; font-weight: 600;">Set Weather Location</h2>

        <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
          <div style="font-size: 14px; color: #1976D2; margin-bottom: 8px;">
            <strong>Current Location:</strong>
          </div>
          <div id="currentLocationDisplay" style="font-size: 14px; color: #333;">
            Loading...
          </div>
        </div>

        <div style="margin-bottom: 20px;">
          <h3 style="font-size: 16px; margin-bottom: 10px;">Option 1: Use Browser Location</h3>
          <button class="btn btn-secondary" onclick="requestBrowserLocation()" style="width: 100%;">
            üìç Request Browser Permission
          </button>
          <p style="font-size: 12px; color: #666; margin-top: 5px;">Most accurate - uses your device GPS</p>
        </div>

        <div style="margin-bottom: 20px;">
          <h3 style="font-size: 16px; margin-bottom: 10px;">Option 2: Enter Coordinates</h3>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div class="form-group" style="margin-bottom: 0;">
              <label>Latitude</label>
              <input type="number" id="manualLat" placeholder="41.878" step="0.0001" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px;">
            </div>
            <div class="form-group" style="margin-bottom: 0;">
              <label>Longitude</label>
              <input type="number" id="manualLng" placeholder="-93.098" step="0.0001" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px;">
            </div>
          </div>
          <button class="btn" onclick="setManualLocation()" style="width: 100%; margin-top: 10px;">
            Save Coordinates
          </button>
          <p style="font-size: 12px; color: #666; margin-top: 5px;">
            Find coordinates on <a href="https://www.google.com/maps" target="_blank" style="color: #2196F3;">Google Maps</a> (right-click ‚Üí coordinates)
          </p>
        </div>

        <div style="border-top: 1px solid #ddd; padding-top: 15px; margin-top: 20px;">
          <button class="btn btn-danger" onclick="closeLocationSettings()" style="width: 100%;">
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- Weather Details & Activity Windows -->
    <div class="card" style="margin-bottom: 40px;" id="weatherDetails">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="font-size: 24px; font-weight: 600; color: #333; margin: 0;">Weather & Activity Windows</h2>
        <button class="btn btn-secondary" onclick="refreshWeather()" style="padding: 10px 20px;">üîÑ Refresh</button>
      </div>

      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
        <!-- Current Conditions -->
        <div style="background: #f5f5f5; padding: 20px; border-radius: 12px;">
          <h3 style="margin-bottom: 15px; font-size: 18px;">Current Conditions</h3>
          <div id="currentWeatherDetails" style="font-size: 14px; line-height: 1.8;">
            <div>Loading...</div>
          </div>
        </div>

        <!-- Activity Windows -->
        <div style="background: #f5f5f5; padding: 20px; border-radius: 12px;">
          <h3 style="margin-bottom: 15px; font-size: 18px;">Activity Windows</h3>
          <div id="activityWindows" style="font-size: 14px; line-height: 1.8;">
            <div>Loading...</div>
          </div>
        </div>
      </div>

      <!-- 3-Day Forecast -->
      <div style="margin-top: 20px;">
        <h3 style="margin-bottom: 15px; font-size: 18px;">3-Day Forecast</h3>
        <div id="forecastContainer" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
          <div>Loading forecast...</div>
        </div>
      </div>
    </div>

    <!-- Suggested Activities -->
    <div id="suggestedActivities" class="card" style="margin-bottom: 40px;"></div>

    <!-- Pest & Disease Insights -->
    <div id="pestInsights" class="card" style="margin-bottom: 40px; display: none;"></div>

    <h2 style="font-size: 24px; font-weight: 600; color: #333; margin-bottom: 20px;">Recent Activity</h2>
    <div id="recentActivity" class="card">
      <p style="text-align: center; color: #999; padding: 20px;">No activities logged yet. Click "Log Activity" to get started!</p>
    </div>

    <h2 style="font-size: 24px; font-weight: 600; color: #333; margin-bottom: 20px;">Crop Scouting History</h2>
    <div id="cropHistory" class="card">
      <p style="text-align: center; color: #999; padding: 20px;">No crop scouting yet. Click "Crop Scouting" to start monitoring!</p>
    </div>
  </div>

  <!-- Log Activity Screen -->
  <div id="logScreen" class="container hidden">
    <button class="btn" onclick="showScreen('dashboard')">‚Üê Back to Dashboard</button>
    <h2 style="font-size: 24px; font-weight: 600; color: #333; margin: 30px 0 20px;">Log Activity</h2>
    
    <div class="card" style="max-width: 600px;">
      <div class="form-group" style="position: relative;">
        <label>Activity Type</label>
        <input type="text" id="activityType" placeholder="Start typing..." oninput="filterActivities(this.value)">
        <div id="activitySuggestions" class="suggestion-box hidden"></div>
      </div>
      
      <div id="fieldSelectGroup" class="form-group hidden" style="position: relative;">
        <label>Field</label>
        <input type="text" id="fieldSelect" placeholder="Type to search fields..." oninput="filterFields(this.value)">
        <div id="fieldSuggestions" class="suggestion-box hidden"></div>
      </div>

      <div id="dateGroup" class="form-group hidden">
        <label>Date</label>
        <input type="date" id="activityDate">
      </div>

      <div id="productGroup" class="form-group hidden">
        <label>Product</label>
        <select id="productSelect"></select>
      </div>

      <div id="rateGroup" class="form-group hidden">
        <label>Application Rate</label>
        <div style="display: flex; gap: 10px;">
          <input type="number" id="applicationRate" placeholder="13.7" style="flex: 1;">
          <select id="rateUnit">
            <option value="oz/acre">oz/acre</option>
            <option value="gal/acre">gal/acre</option>
            <option value="lb/acre">lb/acre</option>
          </select>
        </div>
      </div>

      <div id="seedGroup" class="form-group hidden">
        <div class="form-group">
          <label>Variety</label>
          <input type="text" id="seedVariety" placeholder="e.g., DeKalb 62-54">
        </div>
        <div class="form-group">
          <label>Population (seeds/acre)</label>
          <input type="number" id="seedPopulation" placeholder="e.g., 32000">
        </div>
      </div>

      <div id="harvestGroup" class="form-group hidden" style="background: #e8f5e9; padding: 20px; border-radius: 8px;">
        <h3 style="margin-bottom: 15px; color: #2e7d32;">Revenue Information</h3>
        <div class="form-group">
          <label>Total Bushels</label>
          <input type="number" id="totalBushels" placeholder="e.g., 8500">
        </div>
        <div class="form-group">
          <label>Price per Bushel ($)</label>
          <input type="number" step="0.01" id="pricePerBushel" placeholder="e.g., 4.25">
        </div>
        <div id="harvestCalc" style="padding: 12px; background: white; border-radius: 6px; margin-top: 10px; font-size: 14px; display: none;"></div>
      </div>

      <div id="fuelGroup" class="form-group hidden">
        <label>Fuel Cost ($) - Optional</label>
        <input type="number" step="0.01" id="fuelCost" placeholder="e.g., 45.00">
      </div>

      <button id="logActivityBtn" class="btn hidden" style="width: 100%; margin-top: 20px;" onclick="logActivity()">Log Activity</button>
    </div>
  </div>

  <!-- Manage Fields Screen -->
  <div id="fieldsScreen" class="container hidden">
    <button class="btn" onclick="showScreen('dashboard')">‚Üê Back to Dashboard</button>
    <h2 style="font-size: 24px; font-weight: 600; color: #333; margin: 30px 0 20px;">Manage Fields</h2>
    
    <button class="btn" onclick="showAddField()" style="margin-bottom: 20px;">+ Create New Field</button>

    <!-- Map Field Creation -->
    <div id="addFieldForm" class="card hidden">
      <h3 style="margin-bottom: 15px;">Create Field on Map</h3>
      <div class="form-group">
        <label>Field Name</label>
        <input type="text" id="newFieldName" placeholder="e.g., Red Road 40">
      </div>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 500; color: #555;">Import Shapefile (Optional)</label>
        <input type="file" id="shapefileInput" accept=".zip,.shp,.dbf,.shx" style="display: none;" onchange="handleShapefileUpload(event)">
        <button class="btn btn-secondary" onclick="document.getElementById('shapefileInput').click()">üìÅ Upload Shapefile</button>
        <p style="font-size: 12px; color: #666; margin-top: 5px;">Upload a .zip file containing .shp, .shx, and .dbf files</p>
      </div>
      
      <div style="position: relative;">
        <div id="map"></div>
        <div class="map-controls">
          <button id="undoBtn" class="btn btn-warning hidden" onclick="undoLastPoint()">‚Ü∂ Undo</button>
          <button id="createFieldBtn" class="btn hidden" onclick="createFieldFromMap()">‚úì Create Field</button>
          <button class="btn btn-danger" onclick="cancelAddField()">‚úï Cancel</button>
        </div>
        <div class="map-info">
          <h4>Field Information</h4>
          <div class="acres" id="mapAcres">0.00</div>
          <div class="points" id="mapPoints">Drop points to mark boundary</div>
        </div>
      </div>
    </div>

    <div id="fieldsList"></div>
  </div>

  <!-- Manage Inventory Screen -->
  <div id="inventoryScreen" class="container hidden">
    <button class="btn" onclick="showScreen('dashboard')">‚Üê Back to Dashboard</button>
    <h2 style="font-size: 24px; font-weight: 600; color: #333; margin: 30px 0 20px;">Manage Inventory</h2>
    
    <button class="btn" onclick="showAddProduct()" style="margin-bottom: 20px;">+ Add Product</button>

    <div id="addProductForm" class="card hidden" style="max-width: 500px;">
      <h3 style="margin-bottom: 15px;">New Product</h3>
      <div class="form-group">
        <label>Product Name</label>
        <input type="text" id="newProductName" placeholder="e.g., Miravis Neo">
      </div>
      <div style="display: flex; gap: 10px;">
        <div class="form-group" style="flex: 1;">
          <label>Amount</label>
          <input type="number" id="newProductAmount" placeholder="e.g., 5">
        </div>
        <div class="form-group" style="flex: 1;">
          <label>Unit</label>
          <select id="newProductUnit">
            <option value="gallon">Gallon</option>
            <option value="ounce">Ounce</option>
            <option value="pound">Pound</option>
            <option value="ton">Ton</option>
            <option value="bag">Bag</option>
          </select>
        </div>
      </div>
      <div style="display: flex; gap: 10px; align-items: center;">
        <div class="form-group" style="flex: 1;">
          <label>Total Cost</label>
          <input type="number" step="0.01" id="newProductTotalCost" placeholder="$250" oninput="calcCostPerUnit()">
        </div>
        <div style="padding: 0 10px; margin-top: 20px;">OR</div>
        <div class="form-group" style="flex: 1;">
          <label>Cost Per Unit</label>
          <input type="number" step="0.01" id="newProductCostPerUnit" placeholder="$50" oninput="calcTotalCost()">
        </div>
      </div>
      <button class="btn" onclick="addProduct()" style="margin-right: 10px;">Add Product</button>
      <button class="btn btn-danger" onclick="cancelAddProduct()">Cancel</button>
    </div>

    <div id="inventoryList"></div>
  </div>

  <!-- Crop Scouting Screen -->
  <div id="scoutingScreen" class="container hidden">
    <button class="btn" onclick="showScreen('dashboard')">‚Üê Back to Dashboard</button>
    <h2 style="font-size: 24px; font-weight: 600; color: #333; margin: 30px 0 20px;">Crop Scouting</h2>
    
    <!-- Field Selection -->
    <div id="scoutingFieldSelect" class="card" style="max-width: 600px;">
      <h3 style="margin-bottom: 15px;">Select Field to Scout</h3>
      <div id="scoutingFieldsList"></div>
    </div>

    <!-- Scouting Map Interface -->
    <div id="scoutingMapView" class="card hidden">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h3 id="scoutingFieldName">Field Name</h3>
        <button class="btn btn-secondary" onclick="backToFieldSelection()">Change Field</button>
      </div>
      
      <div style="position: relative;">
        <div id="scoutingMap" style="width: 100%; height: 600px; border-radius: 12px; background-color: #e0e0e0;">
          <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666; font-size: 16px;">
            Loading map...
          </div>
        </div>
        
        <!-- Scouting Controls -->
        <div style="position: absolute; top: 10px; left: 10px; z-index: 1; display: flex; flex-direction: column; gap: 10px;">
          <button id="pinModeBtn" class="btn" onclick="togglePinMode()" style="background: #FF5722;">üìç Drop Pins</button>
          <button id="zoneModeBtn" class="btn" onclick="toggleZoneMode()" style="background: #FF9800;">üü¢ Draw Zone</button>
          <button id="fieldModeBtn" class="btn" onclick="markWholeField()" style="background: #4CAF50;">üåæ Whole Field</button>
          <button id="heatMapBtn" class="btn btn-secondary" onclick="toggleHeatMap()" style="background: #9C27B0;">üî• Heat Map</button>
          <button id="undoPestBtn" class="btn btn-warning hidden" onclick="undoLastPestPoint()">‚Ü∂ Undo</button>
          <button id="completePestBtn" class="btn hidden" onclick="completePestMarking()" style="background: #4CAF50;">‚úì Complete</button>
        </div>

        <!-- Active Crop Log Form -->
        <div id="cropLogForm" class="hidden" style="position: absolute; top: 10px; right: 10px; z-index: 1; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); max-width: 320px; max-height: 80vh; overflow-y: auto;">
          <h4 style="margin-bottom: 15px;">Log Crop Observation</h4>

          <div class="form-group">
            <label>Observation Type</label>
            <select id="observationType" onchange="updateObservationFields()" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px;">
              <option value="pest">Pest Observation</option>
              <option value="growth">Growth Stage</option>
              <option value="stand">Stand Count</option>
              <option value="general">General Observation</option>
            </select>
          </div>

          <div id="pestFields">
            <div class="form-group">
              <label>Pest Category</label>
              <select id="pestCategory" onchange="updatePestList()" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px;">
                <option value="">Select category...</option>
                <option value="weed">Weed</option>
                <option value="insect">Insect</option>
                <option value="disease">Disease/Fungus</option>
              </select>
            </div>

            <div class="form-group">
              <label>Pest Name</label>
              <select id="pestType" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px;">
                <option value="">Select category first...</option>
              </select>
            </div>

            <div id="treatmentRecommendation" style="display: none; margin: 10px 0; padding: 12px; background: #e3f2fd; border-left: 4px solid #2196F3; border-radius: 4px;">
              <div style="font-size: 14px; color: #1976D2;">
                <strong>Recommended Treatment:</strong> <span id="recommendedTreatment">-</span>
              </div>
            </div>

            <div class="form-group">
              <label>Severity</label>
              <input type="range" id="pestSeverity" min="1" max="5" value="3" oninput="updateSeverityLabel(this.value)" style="width: 100%;">
              <div style="display: flex; justify-content: space-between; font-size: 12px; color: #666;">
                <span>Low</span>
                <span id="severityLabel" style="font-weight: 600; color: #FF9800;">Medium</span>
                <span>High</span>
              </div>
            </div>
          </div>

          <div id="growthFields" class="hidden">
            <div class="form-group">
              <label>Crop Type</label>
              <select id="growthCropType" onchange="updateGrowthStages()" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px;">
                <option value="">Select crop...</option>
                <option value="corn">Corn</option>
                <option value="soybeans">Soybeans</option>
                <option value="wheat">Wheat</option>
              </select>
            </div>

            <div class="form-group">
              <label>Growth Stage</label>
              <select id="growthStage" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px;">
                <option value="">Select crop first...</option>
              </select>
            </div>

            <div id="growthStageInfo" style="background: #e8f5e9; padding: 12px; border-radius: 6px; font-size: 13px; margin-top: 10px; display: none;">
              <div id="stageDescription"></div>
            </div>
          </div>

          <div id="standFields" class="hidden">
            <div class="form-group">
              <label>Row Length (feet)</label>
              <input type="number" id="rowLength" placeholder="e.g., 17.5" step="0.1" oninput="calculateYield()" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px;">
            </div>

            <div class="form-group">
              <label>Row Spacing (inches)</label>
              <select id="rowSpacing" onchange="calculateYield()" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px;">
                <option value="30">30 inches</option>
                <option value="20">20 inches</option>
                <option value="15">15 inches</option>
                <option value="7.5">7.5 inches</option>
              </select>
            </div>

            <div class="form-group">
              <label>Plant Count</label>
              <input type="number" id="plantCount" placeholder="Count plants in row" oninput="calculateYield()" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px;">
            </div>

            <div class="form-group">
              <label>Expected Ears per Plant (corn only)</label>
              <input type="number" id="earsPerPlant" value="1" step="0.1" oninput="calculateYield()" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px;">
            </div>

            <div class="form-group">
              <label>Kernel Rows per Ear (corn only)</label>
              <input type="number" id="kernelRows" value="16" oninput="calculateYield()" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px;">
            </div>

            <div class="form-group">
              <label>Kernels per Row (corn only)</label>
              <input type="number" id="kernelsPerRow" value="30" oninput="calculateYield()" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px;">
            </div>

            <div id="yieldPrediction" style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin: 10px 0; display: none;">
              <h4 style="margin-bottom: 10px; color: #2e7d32;">Yield Prediction & Stand Analysis</h4>
              <div style="font-size: 14px; line-height: 1.6;">
                <div><strong>Current Stand:</strong> <span id="plantsPerAcre">-</span> plants/acre</div>
                <div id="populationLossDiv" style="display: none; margin: 8px 0; padding: 10px; background: #fff3cd; border-left: 4px solid #ff9800; border-radius: 4px;">
                  <div><strong>Planted Population:</strong> <span id="plantedPopulation">-</span> plants/acre</div>
                  <div style="color: #d32f2f; font-weight: 600; margin-top: 4px;"><strong>Population Loss:</strong> <span id="populationLoss">-</span> plants (<span id="populationLossPercent">-</span>%)</div>
                </div>
                <div style="margin-top: 8px;"><strong>Estimated Yield:</strong> <span id="estimatedYield" style="font-size: 18px; color: #2e7d32; font-weight: 700;">-</span></div>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label>Photo (Optional)</label>
            <input type="file" id="cropPhoto" accept="image/*" capture="environment" style="font-size: 14px; padding: 8px;">
          </div>

          <div class="form-group">
            <label>Notes (Optional)</label>
            <textarea id="cropNotes" rows="3" placeholder="Additional observations..." style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 6px; font-family: 'Exo 2', sans-serif;"></textarea>
          </div>

          <button class="btn" onclick="saveCropObservation()" style="width: 100%; margin-bottom: 10px;">Save Observation</button>
          <button class="btn btn-danger" onclick="cancelCropLog()" style="width: 100%;">Cancel</button>
        </div>
      </div>

      <!-- Crop Observations List -->
      <div id="fieldCropList" style="margin-top: 20px;">
        <h4 style="margin-bottom: 10px;">Recent Observations</h4>
        <div id="cropObservationsList"></div>
      </div>
    </div>
  </div>

  <!-- Insights Screen -->
  <div id="insightsScreen" class="container hidden">
    <button class="btn" onclick="showScreen('dashboard')">‚Üê Back to Dashboard</button>
    <h2 style="font-size: 28px; font-weight: 600; color: #333; margin: 30px 0 20px; text-align: center;">Insights</h2>
    <div id="insightsContent"></div>
  </div>

  <!-- My Operation Screen -->
  <div id="operationScreen" class="container hidden">
    <button class="btn" onclick="showScreen('dashboard')">‚Üê Back to Dashboard</button>
    <h2 style="font-size: 28px; font-weight: 600; color: #333; margin: 30px 0 20px;">üìä My Operation</h2>
    <p style="color: #666; margin-bottom: 30px; font-size: 16px;">Complete overview of all fields, activities, and scouting data</p>

    <div id="growingZoneInfo" style="margin-bottom: 30px; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; color: white; display: none;">
      <h3 style="font-size: 20px; margin-bottom: 10px;">üåç Your Growing Zone</h3>
      <div id="growingZoneDisplay" style="font-size: 16px;"></div>
      <button onclick="uploadGrowingZone()" style="margin-top: 10px; padding: 8px 16px; background: rgba(255,255,255,0.2); border: 1px solid white; border-radius: 6px; color: white; cursor: pointer; font-family: 'Exo 2', sans-serif;">üì§ Upload Zone Data</button>
    </div>

    <div id="operationContent" style="display: grid; gap: 30px;"></div>
  </div>

  <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoiY2FsZWIxMDAyIiwiYSI6ImNtaG1uNXh3NTBkcmEyaXE0ZG15aHllZGMifQ.t1Y6b25l7tzkiClKXf_lBA';
    
    let currentUser = null;
    let fields = [];
    let inventory = [];
    let activities = [];
    let activityLogs = [];
    
    // Map variables
    let map = null;
    let mapPoints = [];
    let polygonLayer = null;
    let markersLayer = [];

    // Crop scouting variables
    let scoutingMap = null;
    let currentScoutingField = null;
    let cropObservations = [];
    let scoutingMode = null; // 'pin', 'zone', or 'field'
    let zonePoints = [];
    let zoneMarkers = [];
    let tempCropLocation = null;
    let heatMapVisible = false;
    let tempPins = []; // Track multiple pins in pin mode
    let tempPinMarkers = []; // Visual markers for pins

    // Weather variables
    let weatherData = null;
    let forecastData = null;
    let farmLocation = null; // { lat, lng }

    // Growing zone data
    let growingZone = null; // { zone: '5a', frostDates: { last: '...', first: '...' } }

    // Growth stage definitions
    const growthStages = {
      corn: [
        { code: 'VE', name: 'VE - Emergence', description: 'Coleoptile visible above soil surface' },
        { code: 'V1', name: 'V1 - First Leaf', description: 'First leaf collar visible' },
        { code: 'V2', name: 'V2 - Second Leaf', description: 'Second leaf collar visible' },
        { code: 'V3', name: 'V3 - Third Leaf', description: 'Third leaf collar visible' },
        { code: 'V4', name: 'V4 - Fourth Leaf', description: 'Fourth leaf collar visible' },
        { code: 'V5', name: 'V5 - Fifth Leaf', description: 'Fifth leaf collar visible' },
        { code: 'V6', name: 'V6 - Sixth Leaf', description: 'Sixth leaf collar visible' },
        { code: 'V8', name: 'V8 - Eighth Leaf', description: 'Eighth leaf collar visible' },
        { code: 'V10', name: 'V10 - Tenth Leaf', description: 'Tenth leaf collar visible' },
        { code: 'V12', name: 'V12 - Twelfth Leaf', description: 'Twelfth leaf collar visible' },
        { code: 'V14', name: 'V14 - Fourteenth Leaf', description: 'Fourteenth leaf collar visible' },
        { code: 'VT', name: 'VT - Tasseling', description: 'Tassel fully emerged' },
        { code: 'R1', name: 'R1 - Silking', description: 'Silks visible outside husks' },
        { code: 'R2', name: 'R2 - Blister', description: 'Kernels white/clear, blister stage' },
        { code: 'R3', name: 'R3 - Milk', description: 'Kernels yellow, milky fluid' },
        { code: 'R4', name: 'R4 - Dough', description: 'Kernels paste-like, dough stage' },
        { code: 'R5', name: 'R5 - Dent', description: 'Kernel dent forms' },
        { code: 'R6', name: 'R6 - Physiological Maturity', description: 'Black layer formed, ready for harvest' }
      ],
      soybeans: [
        { code: 'VE', name: 'VE - Emergence', description: 'Cotyledons above soil surface' },
        { code: 'VC', name: 'VC - Cotyledon', description: 'Unifoliate leaves unrolled' },
        { code: 'V1', name: 'V1 - First Node', description: 'First trifoliate leaf fully developed' },
        { code: 'V2', name: 'V2 - Second Node', description: 'Two nodes with fully developed leaves' },
        { code: 'V3', name: 'V3 - Third Node', description: 'Three nodes with fully developed leaves' },
        { code: 'V4', name: 'V4 - Fourth Node', description: 'Four nodes with fully developed leaves' },
        { code: 'V5', name: 'V5 - Fifth Node', description: 'Five nodes with fully developed leaves' },
        { code: 'V6', name: 'V6 - Sixth Node', description: 'Six nodes with fully developed leaves' },
        { code: 'R1', name: 'R1 - Beginning Flowering', description: 'One open flower at any node' },
        { code: 'R2', name: 'R2 - Full Flowering', description: 'Open flower at one of two uppermost nodes' },
        { code: 'R3', name: 'R3 - Beginning Pod', description: 'Pod 3/16 inch long at one of four uppermost nodes' },
        { code: 'R4', name: 'R4 - Full Pod', description: 'Pod 3/4 inch at one of four uppermost nodes' },
        { code: 'R5', name: 'R5 - Beginning Seed', description: 'Seed 1/8 inch at one of four uppermost nodes' },
        { code: 'R6', name: 'R6 - Full Seed', description: 'Pod with full-size green seed' },
        { code: 'R7', name: 'R7 - Beginning Maturity', description: 'One normal pod has reached mature color' },
        { code: 'R8', name: 'R8 - Full Maturity', description: '95% of pods at mature color, ready for harvest' }
      ],
      wheat: [
        { code: 'GE', name: 'Germination/Emergence', description: 'Seed germinating, coleoptile emerging' },
        { code: 'T', name: 'Tillering', description: 'Tillers forming from main stem' },
        { code: 'J', name: 'Jointing', description: 'First node visible above soil' },
        { code: 'B', name: 'Booting', description: 'Flag leaf sheath swollen' },
        { code: 'H', name: 'Heading', description: 'Head emergence from boot' },
        { code: 'FL', name: 'Flowering/Anthesis', description: 'Anthers extruded, pollen shedding' },
        { code: 'MF', name: 'Milk Fill', description: 'Kernel milky white fluid' },
        { code: 'DF', name: 'Dough Fill', description: 'Kernel soft dough consistency' },
        { code: 'M', name: 'Mature/Ripening', description: 'Kernel hard, ready for harvest' }
      ]
    };

    // Comprehensive US Pest Database
    const pestDatabase = {
      weeds: {
        corn: ['Waterhemp', 'Palmer Amaranth', 'Giant Ragweed', 'Common Ragweed', 'Foxtail (Giant)', 'Foxtail (Green)', 'Foxtail (Yellow)', 'Velvetleaf', 'Lambsquarters', 'Pigweed (Redroot)', 'Pigweed (Smooth)', 'Cocklebur', 'Morningglory', 'Kochia', 'Marestail (Horseweed)', 'Shattercane', 'Johnsongrass', 'Barnyard Grass', 'Crabgrass', 'Fall Panicum', 'Smartweed', 'Common Sunflower', 'Wild Mustard', 'Canada Thistle', 'Field Bindweed', 'Nutsedge (Yellow)', 'Nutsedge (Purple)', 'Quackgrass'],
        soybeans: ['Waterhemp', 'Palmer Amaranth', 'Giant Ragweed', 'Common Ragweed', 'Foxtail (Giant)', 'Foxtail (Green)', 'Foxtail (Yellow)', 'Velvetleaf', 'Lambsquarters', 'Pigweed (Redroot)', 'Pigweed (Smooth)', 'Cocklebur', 'Morningglory', 'Kochia', 'Marestail (Horseweed)', 'Burcucumber', 'Canada Thistle', 'Field Bindweld', 'Common Sunflower', 'Wild Mustard', 'Smartweed', 'Barnyard Grass', 'Crabgrass', 'Johnsongrass', 'Volunteer Corn', 'Nutsedge (Yellow)', 'Nutsedge (Purple)', 'Dandelion', 'Henbit'],
        wheat: ['Downy Brome (Cheatgrass)', 'Italian Ryegrass', 'Wild Oat', 'Jointed Goatgrass', 'Henbit', 'Purple Deadnettle', 'Field Pennycress', 'Shepherds Purse', 'Marestail (Horseweed)', 'Common Chickweed', 'Canada Thistle', 'Dandelion', 'Wild Mustard', 'Kochia', 'Russian Thistle', 'Wild Buckwheat', 'Foxtail (Green)', 'Quackgrass', 'Volunteer Canola']
      },
      insects: {
        corn: ['Corn Rootworm (Western)', 'Corn Rootworm (Northern)', 'European Corn Borer', 'Corn Earworm', 'Fall Armyworm', 'True Armyworm', 'Black Cutworm', 'Western Bean Cutworm', 'Wireworm', 'White Grub', 'Japanese Beetle', 'Corn Flea Beetle', 'Seed Corn Maggot', 'Stalk Borer', 'Aphid (Corn Leaf)', 'Aphid (Bird Cherry-Oat)', 'Grasshopper', 'Spider Mite (Two-Spotted)', 'Billbug', 'Chinch Bug', 'Southern Corn Rootworm (Spotted Cucumber Beetle)', 'Sap Beetle'],
        soybeans: ['Soybean Aphid', 'Bean Leaf Beetle', 'Japanese Beetle', 'Grasshopper', 'Spider Mite (Two-Spotted)', 'Potato Leafhopper', 'Stink Bug (Brown)', 'Stink Bug (Green)', 'Soybean Cyst Nematode', 'Corn Earworm', 'Armyworm', 'Cutworm (Black)', 'Cutworm (Dingy)', 'Seed Corn Maggot', 'Wireworm', 'White Grub', 'Thistle Caterpillar', 'Woollybear Caterpillar', 'Grape Colaspis', 'Threecornered Alfalfa Hopper', 'Dectes Stem Borer', 'Mexican Bean Beetle'],
        wheat: ['Hessian Fly', 'Wheat Stem Sawfly', 'Armyworm (True)', 'Aphid (Bird Cherry-Oat)', 'Aphid (Greenbug)', 'Aphid (English Grain)', 'Aphid (Russian Wheat)', 'Grasshopper', 'Wheat Curl Mite', 'Cereal Leaf Beetle', 'Wireworm', 'White Grub', 'Cutworm (Army)', 'Fall Armyworm', 'Wheat Jointworm', 'Wheat Midge', 'Brown Wheat Mite', 'Stink Bug']
      },
      diseases: {
        corn: ['Gray Leaf Spot', 'Northern Corn Leaf Blight', 'Southern Corn Leaf Blight', 'Common Rust', 'Southern Rust', 'Eyespot', 'Tar Spot', 'Anthracnose', 'Goss\'s Wilt', 'Stewart\'s Wilt', 'Bacterial Leaf Streak', 'Holcus Spot', 'Diplodia Ear Rot', 'Gibberella Ear Rot', 'Fusarium Ear Rot', 'Aspergillus Ear Rot', 'Common Smut', 'Head Smut', 'Crazy Top', 'Corn Lethal Necrosis', 'Maize Dwarf Mosaic Virus', 'Pythium Seedling Blight', 'Fusarium Stalk Rot', 'Gibberella Stalk Rot', 'Anthracnose Stalk Rot', 'Diplodia Stalk Rot'],
        soybeans: ['White Mold (Sclerotinia)', 'Frogeye Leaf Spot', 'Brown Spot (Septoria)', 'Cercospora Leaf Blight', 'Sudden Death Syndrome', 'Charcoal Rot', 'Phytophthora Root Rot', 'Pythium Root Rot', 'Rhizoctonia Root Rot', 'Fusarium Root Rot', 'Brown Stem Rot', 'Pod and Stem Blight', 'Stem Canker', 'Bacterial Blight', 'Bacterial Pustule', 'Wildfire', 'Downy Mildew', 'Powdery Mildew', 'Soybean Rust', 'Target Spot', 'Anthracnose', 'Purple Seed Stain', 'Phomopsis Seed Decay', 'Soybean Mosaic Virus', 'Bean Pod Mottle Virus'],
        wheat: ['Stripe Rust (Yellow Rust)', 'Leaf Rust', 'Stem Rust', 'Powdery Mildew', 'Septoria Tritici Blotch', 'Tan Spot', 'Stagonospora Nodorum Blotch', 'Fusarium Head Blight (Scab)', 'Loose Smut', 'Common Bunt (Stinking Smut)', 'Dwarf Bunt', 'Flag Smut', 'Take-All', 'Pythium Root Rot', 'Rhizoctonia Root Rot', 'Fusarium Crown Rot', 'Common Root Rot', 'Barley Yellow Dwarf Virus', 'Wheat Streak Mosaic Virus', 'Wheat Spindle Streak Mosaic Virus', 'Halo Spot', 'Bacterial Leaf Streak', 'Black Chaff', 'Strawbreaker Foot Rot', 'Sharp Eyespot']
      }
    };

    // Pest type and treatment mapping
    const pestTreatments = {
      weed: { treatment: 'Herbicide', color: '#FF6B6B' },
      insect: { treatment: 'Insecticide', color: '#FFA500' },
      disease: { treatment: 'Fungicide', color: '#9B59B6' }
    };

    // Activity database
    const activityTypes = [
      'Field Cultivator', 'Chisel Plow', 'Disk', 'Vertical Tillage', 'No Tillage', 
      'Ripper', 'Moldboard Plow', 'Strip Tillage', 'Harrow',
      'Fungicide Application', 'Herbicide Application', 'Insecticide Application',
      'Pre-Emergent Herbicide', 'Post-Emergent Herbicide',
      'Nitrogen Application', 'Phosphorus Application', 'Anhydrous Ammonia',
      'Liquid Nitrogen', 'Dry Fertilizer', 'Starter Fertilizer',
      'Corn Planting', 'Soybean Planting', 'Wheat Planting',
      'Corn Harvest', 'Soybean Harvest', 'Wheat Harvest',
      'Pest Scouting', 'Disease Scouting', 'Weed Scouting'
    ];

    // Load data from localStorage
    function loadData() {
      const saved = localStorage.getItem('agronomx_data');
      if (saved) {
        const data = JSON.parse(saved);
        fields = data.fields || [];
        inventory = data.inventory || [];
        activityLogs = data.activityLogs || [];
        cropObservations = data.cropObservations || data.pestObservations || []; // Support old data
        growingZone = data.growingZone || null;
      }

      // Load saved location
      const savedLocation = localStorage.getItem('agronomx_location');
      if (savedLocation) {
        farmLocation = JSON.parse(savedLocation);
      }
    }

    // Save data to localStorage
    function saveData() {
      const data = {
        fields: fields,
        inventory: inventory,
        activityLogs: activityLogs,
        cropObservations: cropObservations,
        growingZone: growingZone
      };
      localStorage.setItem('agronomx_data', JSON.stringify(data));
    }

    // Save location to localStorage
    function saveLocation(location) {
      farmLocation = location;
      localStorage.setItem('agronomx_location', JSON.stringify(location));
    }

    function login() {
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      if (email && password) {
        currentUser = email;
        showScreen('dashboard');
      }
    }

    function showScreen(screen) {
      document.querySelectorAll('[id$="Screen"]').forEach(s => s.classList.add('hidden'));
      document.getElementById(screen + 'Screen').classList.remove('hidden');
      if (screen === 'dashboard') updateDashboard();
      if (screen === 'fields') renderFields();
      if (screen === 'inventory') renderInventory();
      if (screen === 'insights') renderInsights();
      if (screen === 'scouting') initScouting();
      if (screen === 'operation') renderMyOperation();
    }

    function updateDashboard() {
      const totalAcres = fields.reduce((sum, f) => sum + f.acres, 0);
      const totalRevenue = activityLogs.reduce((sum, log) => sum + (log.revenue || 0), 0);
      const totalExpenses = activityLogs.reduce((sum, log) => sum + (log.cost || 0), 0);
      const netProfit = totalRevenue - totalExpenses;
      const inventoryValue = inventory.reduce((sum, p) => sum + p.totalValue, 0);

      document.getElementById('statFields').textContent = fields.length;
      document.getElementById('statAcres').textContent = totalAcres > 0 ? `${totalAcres.toFixed(2)} acres` : 'Add your first field';
      
      if (totalRevenue > 0) {
        document.getElementById('statProfit').textContent = `$${netProfit.toLocaleString()}`;
        document.getElementById('statROI').textContent = `${((netProfit / totalRevenue) * 100).toFixed(1)}% ROI`;
        document.getElementById('statProfitCard').style.background = 'linear-gradient(135deg, #2196F3 0%, #1976D2 100%)';
      }

      document.getElementById('statExpenses').textContent = `$${totalExpenses.toLocaleString()}`;
      document.getElementById('statExpensesPerAcre').textContent = totalExpenses > 0 && totalAcres > 0 ? `$${(totalExpenses / totalAcres).toFixed(2)}/acre` : 'Start logging activities';
      
      document.getElementById('statInventory').textContent = `$${inventoryValue.toLocaleString()}`;
      document.getElementById('statInventoryCount').textContent = `${inventory.length} ${inventory.length === 1 ? 'product' : 'products'}`;

      // Recent activity
      const recent = activityLogs.slice(-5).reverse();
      if (recent.length === 0) {
        document.getElementById('recentActivity').innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No activities logged yet</p>';
      } else {
        document.getElementById('recentActivity').innerHTML = recent.map(log => `
          <div style="padding: 15px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between;">
            <div>
              <div style="font-weight: 600;">${log.activity}</div>
              <div style="font-size: 14px; color: #666;">${log.field} ‚Ä¢ ${new Date(log.date).toLocaleDateString()}</div>
            </div>
            <div style="text-align: right;">
              ${log.revenue > 0 ? `<div style="color: #4CAF50; font-weight: 600;">+$${log.revenue.toLocaleString()}</div>` : ''}
              ${log.cost > 0 ? `<div style="color: #FF9800; font-size: 14px;">$${log.cost.toFixed(2)}</div>` : ''}
            </div>
          </div>
        `).join('');
      }

      // Crop history
      const recentCrop = cropObservations.slice(-5).reverse();
      if (recentCrop.length === 0) {
        document.getElementById('cropHistory').innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No crop scouting yet</p>';
      } else {
        document.getElementById('cropHistory').innerHTML = recentCrop.map(obs => {
          const severityColor = obs.severity <= 2 ? '#4CAF50' : obs.severity <= 3 ? '#FF9800' : '#f44336';
          const severityText = obs.severity <= 2 ? 'Low' : obs.severity <= 3 ? 'Medium' : 'High';
          return `
            <div style="padding: 15px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center;">
              <div style="flex: 1;">
                ${obs.photo ? `<img src="${obs.photo}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px; margin-right: 15px; float: left;">` : ''}
                <div style="font-weight: 600; color: #333;">${obs.pestType}</div>
                <div style="font-size: 14px; color: #666;">${obs.fieldName} ‚Ä¢ ${new Date(obs.timestamp).toLocaleDateString()}</div>
                ${obs.notes ? `<div style="font-size: 12px; color: #999; margin-top: 5px;">${obs.notes}</div>` : ''}
              </div>
              <div style="text-align: right;">
                <div style="padding: 4px 12px; background: ${severityColor}; color: white; border-radius: 20px; font-size: 12px; font-weight: 600;">${severityText}</div>
              </div>
            </div>
          `;
        }).join('');
      }

      // Load weather after dashboard updates
      loadWeather();

      // Generate suggested activities
      generateActivitySuggestions();

      // Generate pest and disease insights
      generatePestInsights();
    }

    // Smart Activity Recommendation Engine
    function generateActivitySuggestions() {
      if (fields.length === 0) {
        document.getElementById('suggestedActivities').style.display = 'none';
        return;
      }

      const suggestions = [];

      fields.forEach(field => {
        const fieldActivities = activityLogs.filter(log => log.field === field.name);
        const fieldCropObs = cropObservations.filter(obs => obs.fieldId === field.id);

        // Check what's been done
        const hasPlanting = fieldActivities.some(a => a.activity.toLowerCase().includes('plant'));
        const hasPreEmerge = fieldActivities.some(a => a.activity.toLowerCase().includes('pre-emergent'));
        const hasPostEmerge = fieldActivities.some(a => a.activity.toLowerCase().includes('post-emergent'));
        const hasTillage = fieldActivities.some(a => a.activity.toLowerCase().includes('till') || a.activity.toLowerCase().includes('plow') || a.activity.toLowerCase().includes('disk'));
        const hasFertilizer = fieldActivities.some(a => a.activity.toLowerCase().includes('fertilizer') || a.activity.toLowerCase().includes('nitrogen'));
        const hasFungicide = fieldActivities.some(a => a.activity.toLowerCase().includes('fungicide'));

        // Check growth stage
        const hasEmergence = field.latestGrowthStage && (field.latestGrowthStage.includes('VE') || field.latestGrowthStage.includes('V'));
        const isVegetative = field.latestGrowthStage && field.latestGrowthStage.startsWith('V') && !field.latestGrowthStage.includes('VE');
        const isReproductive = field.latestGrowthStage && field.latestGrowthStage.startsWith('R');
        const isLateVeg = field.latestGrowthStage && (field.latestGrowthStage === 'V8' || field.latestGrowthStage === 'V10' || field.latestGrowthStage === 'V12' || field.latestGrowthStage === 'VT');

        // Check for weed pressure
        const hasWeedPressure = fieldCropObs.some(obs =>
          obs.observationType === 'pest' &&
          obs.pestType &&
          (obs.pestType.toLowerCase().includes('weed') ||
           obs.pestType.toLowerCase().includes('foxtail') ||
           obs.pestType.toLowerCase().includes('pigweed') ||
           obs.pestType.toLowerCase().includes('thistle'))
        );

        const cropType = field.currentCrop.toLowerCase();

        // PHASE 1: Pre-Planting Activities
        if (!hasPlanting) {
          if (!hasTillage) {
            suggestions.push({
              field: field.name,
              activity: 'Tillage',
              reason: 'Prepare field for planting',
              priority: 'high',
              phase: 'Pre-Planting'
            });
          }
          if (!hasPreEmerge && hasTillage) {
            suggestions.push({
              field: field.name,
              activity: 'Pre-Emergent Herbicide',
              reason: 'Apply before planting for weed control',
              priority: 'high',
              phase: 'Pre-Planting'
            });
          }
          if (!hasFertilizer && hasTillage) {
            suggestions.push({
              field: field.name,
              activity: 'Fertilizer Application',
              reason: 'Base fertility before planting',
              priority: 'medium',
              phase: 'Pre-Planting'
            });
          }
          if (hasTillage) {
            suggestions.push({
              field: field.name,
              activity: `${cropType.includes('corn') ? 'Corn' : cropType.includes('soy') ? 'Soybean' : 'Wheat'} Planting`,
              reason: 'Field is prepared and ready',
              priority: 'high',
              phase: 'Planting'
            });
          }
        }

        // PHASE 2: Post-Planting, Pre-Emergence
        if (hasPlanting && !hasEmergence) {
          suggestions.push({
            field: field.name,
            activity: 'Scout Growth Stage',
            reason: 'Check for emergence (VE stage)',
            priority: 'high',
            phase: 'Early Growth'
          });
        }

        // PHASE 3: Post-Emergence
        if (hasPlanting && hasEmergence) {
          if (!hasPostEmerge) {
            suggestions.push({
              field: field.name,
              activity: 'Post-Emergent Herbicide',
              reason: `Emergence confirmed (${field.latestGrowthStageName || 'VE'})`,
              priority: 'high',
              phase: 'Early Growth'
            });
          }

          // Second post-emerge if weeds detected
          if (hasPostEmerge && hasWeedPressure) {
            suggestions.push({
              field: field.name,
              activity: 'Second Post-Emergent Application',
              reason: 'Weed pressure detected in scouting',
              priority: 'high',
              phase: 'Mid Growth'
            });
          }

          // Nitrogen application (corn specific, mid-vegetative)
          if (cropType.includes('corn') && isVegetative && !hasFertilizer) {
            suggestions.push({
              field: field.name,
              activity: 'Nitrogen Application',
              reason: `Corn at ${field.latestGrowthStageName || 'vegetative'} stage`,
              priority: 'high',
              phase: 'Mid Growth'
            });
          }

          // Fungicide at late vegetative / early reproductive
          if ((isLateVeg || isReproductive) && !hasFungicide) {
            suggestions.push({
              field: field.name,
              activity: 'Fungicide Application',
              reason: `Critical growth stage (${field.latestGrowthStageName || 'late vegetative'})`,
              priority: 'medium',
              phase: 'Mid-Late Growth'
            });
          }

          // Scout growth stage regularly
          if (isVegetative) {
            suggestions.push({
              field: field.name,
              activity: 'Scout Growth Stage',
              reason: 'Monitor crop development',
              priority: 'low',
              phase: 'Ongoing'
            });
          }

          // Harvest recommendation
          if (isReproductive && (field.latestGrowthStage === 'R6' || field.latestGrowthStage === 'R8' || field.latestGrowthStage === 'M')) {
            suggestions.push({
              field: field.name,
              activity: `${cropType.includes('corn') ? 'Corn' : cropType.includes('soy') ? 'Soybean' : 'Wheat'} Harvest`,
              reason: `Crop is mature (${field.latestGrowthStageName})`,
              priority: 'high',
              phase: 'Harvest'
            });
          }
        }
      });

      // Display suggestions
      if (suggestions.length === 0) {
        document.getElementById('suggestedActivities').innerHTML = `
          <div style="text-align: center; padding: 20px; color: #999;">
            <div style="font-size: 18px; margin-bottom: 10px;">‚úÖ All caught up!</div>
            <div>No suggested activities at this time.</div>
          </div>
        `;
        return;
      }

      // Group by priority
      const highPriority = suggestions.filter(s => s.priority === 'high');
      const mediumPriority = suggestions.filter(s => s.priority === 'medium');
      const lowPriority = suggestions.filter(s => s.priority === 'low');

      let html = '<h2 style="font-size: 24px; font-weight: 600; color: #333; margin-bottom: 20px;">üéØ Suggested Activities</h2>';

      if (highPriority.length > 0) {
        html += '<h3 style="font-size: 18px; color: #f44336; margin-bottom: 15px;">‚ö†Ô∏è High Priority</h3>';
        html += highPriority.map(s => `
          <div style="background: #ffebee; padding: 15px; border-radius: 8px; margin-bottom: 12px; border-left: 4px solid #f44336;">
            <div style="display: flex; justify-content: space-between; align-items: start;">
              <div style="flex: 1;">
                <div style="font-weight: 600; font-size: 16px; color: #333;">${s.field}</div>
                <div style="font-size: 18px; font-weight: 600; color: #f44336; margin: 5px 0;">${s.activity}</div>
                <div style="font-size: 14px; color: #666;">${s.reason}</div>
                <div style="font-size: 12px; color: #999; margin-top: 5px;">Phase: ${s.phase}</div>
              </div>
              <button class="btn" onclick="showScreen('log')" style="padding: 8px 16px; font-size: 14px;">Log Activity</button>
            </div>
          </div>
        `).join('');
      }

      if (mediumPriority.length > 0) {
        html += '<h3 style="font-size: 18px; color: #FF9800; margin: 20px 0 15px;">üìã Medium Priority</h3>';
        html += mediumPriority.map(s => `
          <div style="background: #fff3e0; padding: 15px; border-radius: 8px; margin-bottom: 12px; border-left: 4px solid #FF9800;">
            <div style="display: flex; justify-content: space-between; align-items: start;">
              <div style="flex: 1;">
                <div style="font-weight: 600; font-size: 16px; color: #333;">${s.field}</div>
                <div style="font-size: 16px; font-weight: 600; color: #FF9800; margin: 5px 0;">${s.activity}</div>
                <div style="font-size: 14px; color: #666;">${s.reason}</div>
                <div style="font-size: 12px; color: #999; margin-top: 5px;">Phase: ${s.phase}</div>
              </div>
              <button class="btn btn-secondary" onclick="showScreen('log')" style="padding: 8px 16px; font-size: 14px;">Log Activity</button>
            </div>
          </div>
        `).join('');
      }

      if (lowPriority.length > 0 && lowPriority.length <= 3) {
        html += '<h3 style="font-size: 18px; color: #4CAF50; margin: 20px 0 15px;">‚úì Routine Tasks</h3>';
        html += lowPriority.map(s => `
          <div style="background: #f1f8f4; padding: 12px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #4CAF50;">
            <div style="font-weight: 600; font-size: 14px; color: #333;">${s.field}: ${s.activity}</div>
            <div style="font-size: 13px; color: #666;">${s.reason}</div>
          </div>
        `).join('');
      }

      document.getElementById('suggestedActivities').innerHTML = html;
    }

    // Pest & Disease Insights Engine
    function generatePestInsights() {
      if (fields.length === 0 || cropObservations.length === 0) {
        document.getElementById('pestInsights').style.display = 'none';
        return;
      }

      const pestIssues = [];

      fields.forEach(field => {
        const fieldObs = cropObservations.filter(obs => obs.fieldId === field.id && obs.observationType === 'pest');

        fieldObs.forEach(obs => {
          const priority = obs.location === 'whole' ? 100 : (obs.location === 'zone' ? 50 : 10);
          const severityBoost = obs.severity || 3;

          pestIssues.push({
            field: field.name,
            fieldAcres: field.acres,
            pest: obs.pestType,
            category: obs.pestCategory,
            treatment: obs.recommendedTreatment,
            severity: obs.severity || 3,
            location: obs.location,
            priority: priority + (severityBoost * 5),
            date: obs.timestamp
          });
        });
      });

      if (pestIssues.length === 0) {
        document.getElementById('pestInsights').style.display = 'none';
        return;
      }

      // Sort by priority (whole field + high severity = highest priority)
      pestIssues.sort((a, b) => b.priority - a.priority);

      // Get top issues
      const topIssues = pestIssues.slice(0, 5);

      let html = '<h2 style="font-size: 24px; font-weight: 600; color: #333; margin-bottom: 20px;">üêõ Pest & Disease Insights</h2>';

      topIssues.forEach(issue => {
        const categoryColor = issue.category === 'disease' ? '#9B59B6' : (issue.category === 'insect' ? '#FFA500' : '#FF6B6B');
        const locationBadge = issue.location === 'whole' ? 'üü• Whole Field' : (issue.location === 'zone' ? 'üüß Zone' : 'üìç Pin');
        const severityStars = '‚≠ê'.repeat(issue.severity);

        // Calculate treatment needs
        let treatmentNeeds = '';
        if (issue.location === 'whole' && issue.fieldAcres) {
          const acresNeedingTreatment = issue.fieldAcres;

          // Check inventory
          const treatmentInventory = inventory.filter(item =>
            item.name.toLowerCase().includes(issue.treatment.toLowerCase())
          );

          let inventoryWarning = '';
          if (treatmentInventory.length > 0) {
            const totalInStock = treatmentInventory.reduce((sum, item) => sum + (item.quantity || 0), 0);
            const estimatedNeed = acresNeedingTreatment; // Simplified - assuming 1 unit per acre

            if (totalInStock < estimatedNeed) {
              inventoryWarning = `
                <div style="background: #fff3cd; padding: 10px; border-radius: 6px; margin-top: 10px; border-left: 3px solid #ff9800;">
                  <strong>‚ö†Ô∏è Inventory Warning:</strong> ${issue.treatment} inventory may be too low to treat ${acresNeedingTreatment.toFixed(1)} acres.
                  <br><span style="font-size: 12px;">In stock: ${totalInStock} units | Estimated need: ~${estimatedNeed.toFixed(1)} units</span>
                </div>
              `;
            }
          } else {
            inventoryWarning = `
              <div style="background: #ffebee; padding: 10px; border-radius: 6px; margin-top: 10px; border-left: 3px solid #f44336;">
                <strong>‚ùå No ${issue.treatment} in inventory</strong> to treat ${acresNeedingTreatment.toFixed(1)} acres.
              </div>
            `;
          }

          treatmentNeeds = inventoryWarning;
        }

        // Disease-specific insight
        let diseaseInsight = '';
        if (issue.category === 'disease') {
          diseaseInsight = `
            <div style="background: #e8eaf6; padding: 10px; border-radius: 6px; margin-top: 10px; border-left: 3px solid #9B59B6;">
              <strong>üí° Insight:</strong> Fungicide application may reduce the spread of ${issue.pest}.
              ${issue.location === 'whole' ? 'Immediate field-wide treatment recommended.' : 'Monitor for spread beyond current area.'}
            </div>
          `;
        }

        html += `
          <div style="background: white; padding: 18px; border-radius: 12px; margin-bottom: 15px; border-left: 5px solid ${categoryColor}; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
              <div style="flex: 1;">
                <div style="font-size: 12px; color: #999; margin-bottom: 5px;">${locationBadge} ‚Ä¢ ${severityStars} Severity</div>
                <div style="font-weight: 600; font-size: 18px; color: #333;">${issue.field}</div>
                <div style="font-size: 16px; color: ${categoryColor}; margin: 5px 0;"><strong>${issue.pest}</strong></div>
                <div style="font-size: 14px; color: #666;">Category: ${issue.category.charAt(0).toUpperCase() + issue.category.slice(1)}</div>
                <div style="font-size: 14px; color: #2196F3; margin-top: 5px;"><strong>Recommended: ${issue.treatment}</strong></div>
              </div>
            </div>
            ${diseaseInsight}
            ${treatmentNeeds}
          </div>
        `;
      });

      document.getElementById('pestInsights').innerHTML = html;
      document.getElementById('pestInsights').style.display = 'block';
    }

    // My Operation Functions
    function renderMyOperation() {
      // Show growing zone if available
      if (growingZone) {
        document.getElementById('growingZoneInfo').style.display = 'block';
        document.getElementById('growingZoneDisplay').innerHTML = `
          <div style="font-size: 18px; font-weight: 600; margin-bottom: 10px;">Zone ${growingZone.zone}</div>
          ${growingZone.frostDates ? `
            <div style="font-size: 14px; opacity: 0.9;">
              Last Frost: ${growingZone.frostDates.last}<br>
              First Frost: ${growingZone.frostDates.first}
            </div>
          ` : ''}
          ${growingZone.insights ? `<div style="margin-top: 10px; font-size: 14px;">${growingZone.insights}</div>` : ''}
        `;
      }

      let html = '';

      // All Fields Overview
      if (fields.length > 0) {
        html += '<div class="card"><h3 style="font-size: 20px; margin-bottom: 15px;">üåæ Fields</h3>';
        fields.forEach(field => {
          const fieldActivities = activityLogs.filter(log => log.field === field.name);
          const fieldScoutings = cropObservations.filter(obs => obs.fieldId === field.id);
          html += `
            <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin-bottom: 12px;">
              <div style="font-size: 18px; font-weight: 600; color: #333; margin-bottom: 8px;">${field.name}</div>
              <div style="font-size: 14px; color: #666; line-height: 1.6;">
                <div><strong>${field.acres} acres</strong> ‚Ä¢ ${field.currentCrop}</div>
                <div style="margin-top: 8px;">
                  <span style="background: #2196F3; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; margin-right: 5px;">
                    ${fieldActivities.length} Activities
                  </span>
                  <span style="background: #FF5722; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px;">
                    ${fieldScoutings.length} Scoutings
                  </span>
                </div>
                ${field.latestGrowthStage ? `
                  <div style="margin-top: 8px; color: #4CAF50; font-weight: 600;">
                    Current Stage: ${field.latestGrowthStageName || field.latestGrowthStage}
                  </div>
                ` : ''}
              </div>
            </div>
          `;
        });
        html += '</div>';
      }

      // All Activities
      if (activityLogs.length > 0) {
        html += '<div class="card"><h3 style="font-size: 20px; margin-bottom: 15px;">üìù All Activities</h3>';
        const recent = activityLogs.slice(-10).reverse();
        recent.forEach(log => {
          html += `
            <div style="padding: 12px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between;">
              <div style="flex: 1;">
                <div style="font-weight: 600;">${log.activity}</div>
                <div style="font-size: 14px; color: #666;">${log.field} ‚Ä¢ ${new Date(log.date).toLocaleDateString()}</div>
                ${log.product ? `<div style="font-size: 13px; color: #999; margin-top: 4px;">${log.product}${log.applicationRate ? ` @ ${log.applicationRate} ${log.rateUnit}` : ''}</div>` : ''}
              </div>
              <div style="text-align: right;">
                ${log.revenue > 0 ? `<div style="color: #4CAF50; font-weight: 600;">+$${log.revenue.toLocaleString()}</div>` : ''}
                ${log.cost > 0 ? `<div style="color: #FF9800; font-size: 14px;">$${log.cost.toFixed(2)}</div>` : ''}
              </div>
            </div>
          `;
        });
        html += '</div>';
      }

      // All Scouting Data
      if (cropObservations.length > 0) {
        html += '<div class="card"><h3 style="font-size: 20px; margin-bottom: 15px;">üåø Scouting Records</h3>';
        const recent = cropObservations.slice(-10).reverse();
        recent.forEach(obs => {
          const severityColor = obs.severity <= 2 ? '#4CAF50' : obs.severity <= 3 ? '#FF9800' : '#f44336';
          const severityText = obs.severity <= 2 ? 'Low' : obs.severity <= 3 ? 'Medium' : 'High';
          const locationBadge = obs.location === 'whole' || obs.location.type === 'field' ? 'üü• Field' :
                               (obs.location.type === 'zone' ? 'üüß Zone' : 'üìç Pin');
          html += `
            <div style="padding: 12px; border-bottom: 1px solid #f0f0f0;">
              <div style="display: flex; justify-content: space-between; align-items: start;">
                <div style="flex: 1;">
                  <div style="font-size: 12px; color: #999; margin-bottom: 4px;">${locationBadge}</div>
                  <div style="font-weight: 600;">${obs.pestType || obs.observationType}</div>
                  <div style="font-size: 14px; color: #666;">${obs.fieldName} ‚Ä¢ ${new Date(obs.timestamp).toLocaleDateString()}</div>
                  ${obs.notes ? `<div style="font-size: 13px; color: #999; margin-top: 4px;">${obs.notes}</div>` : ''}
                </div>
                ${obs.severity ? `
                  <div style="padding: 4px 12px; background: ${severityColor}; color: white; border-radius: 20px; font-size: 12px; font-weight: 600;">${severityText}</div>
                ` : ''}
              </div>
            </div>
          `;
        });
        html += '</div>';
      }

      document.getElementById('operationContent').innerHTML = html || '<p style="text-align: center; color: #999; padding: 40px;">No data yet. Start logging activities and scouting!</p>';
    }

    function uploadGrowingZone() {
      const zone = prompt('Enter your USDA Growing Zone (e.g., 5a, 6b, 7a):');
      if (!zone) return;

      const lastFrost = prompt('Enter average last frost date (e.g., May 15):');
      const firstFrost = prompt('Enter average first frost date (e.g., October 1):');

      growingZone = {
        zone: zone,
        frostDates: lastFrost && firstFrost ? { last: lastFrost, first: firstFrost } : null
      };

      // Add zone-specific insights
      const zoneNum = parseInt(zone);
      if (zoneNum >= 1 && zoneNum <= 3) {
        growingZone.insights = 'Cold climate zone. Focus on cold-hardy varieties and shorter growing seasons.';
      } else if (zoneNum >= 4 && zoneNum <= 6) {
        growingZone.insights = 'Temperate zone ideal for corn, soybeans, and wheat. Plan for late spring planting.';
      } else if (zoneNum >= 7 && zoneNum <= 10) {
        growingZone.insights = 'Warmer zone with extended growing season. Consider double-cropping opportunities.';
      }

      saveData();
      renderMyOperation();
      alert('Growing zone data saved!');
    }

    // Weather Functions
    async function loadWeather() {
      // Priority 1: Check for saved location
      if (farmLocation) {
        fetchWeatherData();
        return;
      }

      // Priority 2: Get from first field coordinates
      if (fields.length > 0 && fields[0].coordinates && fields[0].coordinates.length > 0) {
        const coords = fields[0].coordinates[0];
        farmLocation = { lat: coords[1], lng: coords[0] };
        fetchWeatherData();
        return;
      }

      // Priority 3: Try browser geolocation (silent - no prompt on first load)
      // User can explicitly grant permission via the "Set Location" button
      // For now, just use default location
      farmLocation = { lat: 41.878, lng: -93.098 };
      fetchWeatherData();
    }

    async function fetchWeatherData() {
      if (!farmLocation) return;

      try {
        // Use Open-Meteo API (free, no API key required)
        const currentUrl = `https://api.open-meteo.com/v1/forecast?latitude=${farmLocation.lat}&longitude=${farmLocation.lng}&current=temperature_2m,relative_humidity_2m,precipitation,rain,weather_code,wind_speed_10m,wind_direction_10m&temperature_unit=fahrenheit&wind_speed_unit=mph&precipitation_unit=inch&timezone=America%2FChicago`;

        const forecastUrl = `https://api.open-meteo.com/v1/forecast?latitude=${farmLocation.lat}&longitude=${farmLocation.lng}&daily=weather_code,temperature_2m_max,temperature_2m_min,precipitation_sum,precipitation_probability_max,wind_speed_10m_max&temperature_unit=fahrenheit&wind_speed_unit=mph&precipitation_unit=inch&timezone=America%2FChicago&forecast_days=3`;

        const [currentResponse, forecastResponse] = await Promise.all([
          fetch(currentUrl),
          fetch(forecastUrl)
        ]);

        weatherData = await currentResponse.json();
        forecastData = await forecastResponse.json();

        updateWeatherDisplay();
      } catch (error) {
        console.error('Error fetching weather:', error);
        document.getElementById('weatherTemp').textContent = 'N/A';
        document.getElementById('weatherCondition').textContent = 'Unable to load weather';
      }
    }

    function updateWeatherDisplay() {
      if (!weatherData || !weatherData.current) return;

      const current = weatherData.current;

      // Update weather card
      const temp = Math.round(current.temperature_2m);
      document.getElementById('weatherTemp').textContent = `${temp}¬∞F`;
      document.getElementById('weatherCondition').textContent = getWeatherDescription(current.weather_code);

      // Update detailed current conditions
      const windDir = getWindDirection(current.wind_direction_10m);
      document.getElementById('currentWeatherDetails').innerHTML = `
        <div><strong>Temperature:</strong> ${temp}¬∞F</div>
        <div><strong>Humidity:</strong> ${Math.round(current.relative_humidity_2m)}%</div>
        <div><strong>Wind:</strong> ${Math.round(current.wind_speed_10m)} mph ${windDir}</div>
        <div><strong>Conditions:</strong> ${getWeatherDescription(current.weather_code)}</div>
        ${current.precipitation > 0 ? `<div><strong>Precipitation:</strong> ${current.precipitation.toFixed(2)} in</div>` : ''}
      `;

      // Update activity windows
      updateActivityWindows(current);

      // Update forecast
      updateForecast();
    }

    function updateActivityWindows(current) {
      const windows = [];
      const temp = Math.round(current.temperature_2m);
      const windSpeed = Math.round(current.wind_speed_10m);
      const humidity = Math.round(current.relative_humidity_2m);
      const isRaining = current.precipitation > 0;

      // Spraying window
      if (!isRaining && windSpeed >= 3 && windSpeed <= 10 && temp >= 50 && temp <= 85) {
        windows.push({
          activity: '‚úÖ Spraying',
          status: 'IDEAL',
          reason: 'Good wind, temp, and dry conditions',
          color: '#4CAF50'
        });
      } else if (isRaining) {
        windows.push({
          activity: '‚ùå Spraying',
          status: 'NOT RECOMMENDED',
          reason: 'Precipitation present',
          color: '#f44336'
        });
      } else if (windSpeed > 10) {
        windows.push({
          activity: '‚ö†Ô∏è Spraying',
          status: 'CAUTION',
          reason: `Wind too high (${windSpeed} mph)`,
          color: '#FF9800'
        });
      } else if (windSpeed < 3) {
        windows.push({
          activity: '‚ö†Ô∏è Spraying',
          status: 'CAUTION',
          reason: 'Wind too low for spray drift',
          color: '#FF9800'
        });
      }

      // Planting window
      if (!isRaining && temp >= 50 && temp <= 85 && humidity < 80) {
        windows.push({
          activity: '‚úÖ Planting',
          status: 'GOOD',
          reason: 'Suitable conditions',
          color: '#4CAF50'
        });
      } else if (isRaining) {
        windows.push({
          activity: '‚ùå Planting',
          status: 'WAIT',
          reason: 'Too wet',
          color: '#f44336'
        });
      }

      // Harvesting window
      if (!isRaining && humidity < 18) {
        windows.push({
          activity: '‚úÖ Harvesting',
          status: 'IDEAL',
          reason: `Low moisture (${humidity}%)`,
          color: '#4CAF50'
        });
      } else if (humidity < 22 && !isRaining) {
        windows.push({
          activity: '‚úÖ Harvesting',
          status: 'GOOD',
          reason: `Acceptable moisture (${humidity}%)`,
          color: '#4CAF50'
        });
      } else if (isRaining) {
        windows.push({
          activity: '‚ùå Harvesting',
          status: 'NOT RECOMMENDED',
          reason: 'Wet conditions',
          color: '#f44336'
        });
      }

      // Tillage window
      if (!isRaining && humidity < 70) {
        windows.push({
          activity: '‚úÖ Tillage',
          status: 'GOOD',
          reason: 'Dry enough for field work',
          color: '#4CAF50'
        });
      } else {
        windows.push({
          activity: '‚ö†Ô∏è Tillage',
          status: 'WAIT',
          reason: 'Soil may be too wet',
          color: '#FF9800'
        });
      }

      document.getElementById('activityWindows').innerHTML = windows.map(w => `
        <div style="margin-bottom: 12px; padding: 10px; background: white; border-radius: 6px; border-left: 4px solid ${w.color};">
          <div style="font-weight: 600; color: ${w.color};">${w.activity}</div>
          <div style="font-size: 13px; color: #666;">${w.reason}</div>
        </div>
      `).join('');
    }

    function updateForecast() {
      if (!forecastData || !forecastData.daily) return;

      const daily = forecastData.daily;
      const forecastHtml = [];

      for (let i = 0; i < Math.min(3, daily.time.length); i++) {
        const date = new Date(daily.time[i]);
        const dayName = i === 0 ? 'Today' : i === 1 ? 'Tomorrow' : date.toLocaleDateString('en-US', { weekday: 'short' });

        forecastHtml.push(`
          <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; text-align: center;">
            <div style="font-weight: 600; margin-bottom: 8px;">${dayName}</div>
            <div style="font-size: 28px; margin: 10px 0;">${getWeatherEmoji(daily.weather_code[i])}</div>
            <div style="font-size: 16px; font-weight: 600; color: #f44336;">${Math.round(daily.temperature_2m_max[i])}¬∞</div>
            <div style="font-size: 14px; color: #2196F3;">${Math.round(daily.temperature_2m_min[i])}¬∞</div>
            <div style="font-size: 12px; color: #666; margin-top: 8px;">${getWeatherDescription(daily.weather_code[i])}</div>
            ${daily.precipitation_sum[i] > 0 ? `<div style="font-size: 12px; color: #2196F3; margin-top: 4px;">üíß ${daily.precipitation_sum[i].toFixed(1)}"</div>` : ''}
            <div style="font-size: 12px; color: #666; margin-top: 4px;">üí® ${Math.round(daily.wind_speed_10m_max[i])} mph</div>
          </div>
        `);
      }

      document.getElementById('forecastContainer').innerHTML = forecastHtml.join('');
    }

    function getWeatherDescription(code) {
      const descriptions = {
        0: 'Clear',
        1: 'Mainly Clear',
        2: 'Partly Cloudy',
        3: 'Overcast',
        45: 'Foggy',
        48: 'Foggy',
        51: 'Light Drizzle',
        53: 'Drizzle',
        55: 'Heavy Drizzle',
        61: 'Light Rain',
        63: 'Rain',
        65: 'Heavy Rain',
        71: 'Light Snow',
        73: 'Snow',
        75: 'Heavy Snow',
        77: 'Snow Grains',
        80: 'Light Showers',
        81: 'Showers',
        82: 'Heavy Showers',
        85: 'Light Snow Showers',
        86: 'Snow Showers',
        95: 'Thunderstorm',
        96: 'Thunderstorm',
        99: 'Severe Thunderstorm'
      };
      return descriptions[code] || 'Unknown';
    }

    function getWeatherEmoji(code) {
      if (code === 0) return '‚òÄÔ∏è';
      if (code <= 2) return 'üå§Ô∏è';
      if (code === 3) return '‚òÅÔ∏è';
      if (code === 45 || code === 48) return 'üå´Ô∏è';
      if (code >= 51 && code <= 55) return 'üå¶Ô∏è';
      if (code >= 61 && code <= 65) return 'üåßÔ∏è';
      if (code >= 71 && code <= 77) return 'üå®Ô∏è';
      if (code >= 80 && code <= 82) return 'üåßÔ∏è';
      if (code >= 85 && code <= 86) return 'üå®Ô∏è';
      if (code >= 95) return '‚õàÔ∏è';
      return 'üå§Ô∏è';
    }

    function getWindDirection(degrees) {
      const directions = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'];
      const index = Math.round(degrees / 45) % 8;
      return directions[index];
    }

    function refreshWeather() {
      document.getElementById('weatherTemp').textContent = '--¬∞F';
      document.getElementById('weatherCondition').textContent = 'Refreshing...';
      document.getElementById('currentWeatherDetails').innerHTML = '<div>Loading...</div>';
      document.getElementById('activityWindows').innerHTML = '<div>Loading...</div>';
      document.getElementById('forecastContainer').innerHTML = '<div>Loading...</div>';

      fetchWeatherData();
    }

    // Location Settings Functions
    function showLocationSettings() {
      const modal = document.getElementById('locationModal');
      modal.classList.remove('hidden');
      modal.style.display = 'flex';
      updateCurrentLocationDisplay();

      // Pre-fill manual inputs if location exists
      if (farmLocation) {
        document.getElementById('manualLat').value = farmLocation.lat.toFixed(4);
        document.getElementById('manualLng').value = farmLocation.lng.toFixed(4);
      }
    }

    function closeLocationSettings() {
      console.log('closeLocationSettings called');
      const modal = document.getElementById('locationModal');
      if (!modal) {
        console.error('Modal element not found!');
        return;
      }
      console.log('Hiding modal...');
      modal.classList.add('hidden');
      modal.style.display = 'none';
      console.log('Modal hidden');
    }

    function updateCurrentLocationDisplay() {
      if (!farmLocation) {
        document.getElementById('currentLocationDisplay').innerHTML = 'No location set yet';
        return;
      }

      let source = 'Unknown';
      if (localStorage.getItem('agronomx_location')) {
        source = 'Manually set';
      } else if (fields.length > 0 && fields[0].coordinates) {
        source = 'From first field';
      } else {
        source = 'Browser/Default';
      }

      document.getElementById('currentLocationDisplay').innerHTML = `
        <div><strong>Latitude:</strong> ${farmLocation.lat.toFixed(4)}</div>
        <div><strong>Longitude:</strong> ${farmLocation.lng.toFixed(4)}</div>
        <div style="font-size: 12px; color: #666; margin-top: 5px;">Source: ${source}</div>
      `;
    }

    function requestBrowserLocation() {
      if (!navigator.geolocation) {
        alert('Geolocation is not supported by your browser');
        return;
      }

      document.getElementById('currentLocationDisplay').innerHTML = 'Requesting permission...';

      navigator.geolocation.getCurrentPosition(
        (position) => {
          const location = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };
          saveLocation(location);
          updateCurrentLocationDisplay();
          fetchWeatherData();
          closeLocationSettings();
          alert('Location saved! Weather will update shortly.');
        },
        (error) => {
          let message = 'Unable to get location. ';
          if (error.code === 1) {
            message += 'Permission denied. Please allow location access in your browser settings.';
          } else if (error.code === 2) {
            message += 'Position unavailable.';
          } else if (error.code === 3) {
            message += 'Request timeout.';
          }
          alert(message);
          updateCurrentLocationDisplay();
        }
      );
    }

    function setManualLocation() {
      const lat = parseFloat(document.getElementById('manualLat').value);
      const lng = parseFloat(document.getElementById('manualLng').value);

      if (!lat || !lng || lat < -90 || lat > 90 || lng < -180 || lng > 180) {
        alert('Please enter valid coordinates.\nLatitude: -90 to 90\nLongitude: -180 to 180');
        return;
      }

      const location = { lat, lng };
      saveLocation(location);
      updateCurrentLocationDisplay();
      fetchWeatherData();
      closeLocationSettings();
      alert('Location saved! Weather will update shortly.');
    }

    // Map functions
    function initMap() {
      if (map) {
        map.remove();
      }

      // Get user's location
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((position) => {
          createMap(position.coords.longitude, position.coords.latitude);
        }, () => {
          // Default to center US if location denied
          createMap(-93.0, 40.0);
        });
      } else {
        createMap(-93.0, 40.0);
      }
    }

    function createMap(lng, lat) {
      map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/satellite-streets-v12',
        center: [lng, lat],
        zoom: 15
      });

      map.addControl(new mapboxgl.NavigationControl());

      // Click to add points
      map.on('click', (e) => {
        addMapPoint(e.lngLat.lng, e.lngLat.lat);
      });
    }

    function addMapPoint(lng, lat) {
      mapPoints.push([lng, lat]);
      
      // Add marker
      const el = document.createElement('div');
      el.className = 'marker';
      el.style.width = '20px';
      el.style.height = '20px';
      el.style.borderRadius = '50%';
      el.style.backgroundColor = '#4CAF50';
      el.style.border = '3px solid white';
      el.style.boxShadow = '0 2px 4px rgba(0,0,0,0.3)';
      
      const marker = new mapboxgl.Marker(el)
        .setLngLat([lng, lat])
        .addTo(map);
      
      markersLayer.push(marker);

      // Update UI
      updateMapUI();
      drawPolygon();
    }

    function drawPolygon() {
      // Remove existing layers
      if (map.getLayer('polygon')) {
        map.removeLayer('polygon');
      }
      if (map.getLayer('polygon-outline')) {
        map.removeLayer('polygon-outline');
      }
      if (map.getLayer('line')) {
        map.removeLayer('line');
      }
      if (map.getSource('polygon')) {
        map.removeSource('polygon');
      }
      if (map.getSource('line')) {
        map.removeSource('line');
      }

      if (mapPoints.length < 2) return;

      // Draw line for 2 points
      if (mapPoints.length === 2) {
        map.addSource('line', {
          'type': 'geojson',
          'data': {
            'type': 'Feature',
            'geometry': {
              'type': 'LineString',
              'coordinates': mapPoints
            }
          }
        });

        map.addLayer({
          'id': 'line',
          'type': 'line',
          'source': 'line',
          'layout': {},
          'paint': {
            'line-color': '#4CAF50',
            'line-width': 3
          }
        });
        return;
      }

      // Draw polygon for 3+ points
      const closedPoints = [...mapPoints, mapPoints[0]];

      map.addSource('polygon', {
        'type': 'geojson',
        'data': {
          'type': 'Feature',
          'geometry': {
            'type': 'Polygon',
            'coordinates': [closedPoints]
          }
        }
      });

      map.addLayer({
        'id': 'polygon',
        'type': 'fill',
        'source': 'polygon',
        'layout': {},
        'paint': {
          'fill-color': '#4CAF50',
          'fill-opacity': 0.3
        }
      });

      map.addLayer({
        'id': 'polygon-outline',
        'type': 'line',
        'source': 'polygon',
        'layout': {},
        'paint': {
          'line-color': '#4CAF50',
          'line-width': 3
        }
      });
    }

    function calculateAcres() {
      if (mapPoints.length < 3) return 0;
      
      const closedPoints = [...mapPoints, mapPoints[0]];
      const polygon = turf.polygon([closedPoints]);
      const area = turf.area(polygon);
      const acres = area / 4046.86; // Convert square meters to acres
      
      return acres;
    }

    function updateMapUI() {
      const acres = calculateAcres();
      const pointCount = mapPoints.length;

      document.getElementById('mapAcres').textContent = acres.toFixed(2);
      document.getElementById('mapPoints').textContent = pointCount === 0 ? 'Drop points to mark boundary' : 
                                                          pointCount === 1 ? '1 point dropped' :
                                                          pointCount === 2 ? '2 points dropped (need 1 more)' :
                                                          `${pointCount} points dropped`;

      // Show/hide buttons
      document.getElementById('undoBtn').classList.toggle('hidden', pointCount === 0);
      document.getElementById('createFieldBtn').classList.toggle('hidden', pointCount < 3);
    }

    function undoLastPoint() {
      if (mapPoints.length === 0) return;
      
      mapPoints.pop();
      const marker = markersLayer.pop();
      marker.remove();
      
      updateMapUI();
      drawPolygon();
    }

    function createFieldFromMap() {
      const name = document.getElementById('newFieldName').value;
      if (!name) {
        alert('Please enter a field name');
        return;
      }

      if (mapPoints.length < 3) {
        alert('Please drop at least 3 points to create a field');
        return;
      }

      const acres = calculateAcres();
      
      fields.push({ 
        id: Date.now(), 
        name, 
        acres: parseFloat(acres.toFixed(2)), 
        currentCrop: 'Not planted',
        coordinates: [...mapPoints]
      });
      
      saveData(); // Save to localStorage
      cancelAddField();
      renderFields();
      alert(`Field "${name}" created successfully! (${acres.toFixed(2)} acres)`);
    }

    function showAddField() {
      document.getElementById('addFieldForm').classList.remove('hidden');
      initMap();
    }

    function cancelAddField() {
      document.getElementById('addFieldForm').classList.add('hidden');
      document.getElementById('newFieldName').value = '';
      document.getElementById('shapefileInput').value = '';
      
      // Clear map
      mapPoints = [];
      markersLayer.forEach(m => m.remove());
      markersLayer = [];
      if (map) {
        if (map.getLayer('polygon')) map.removeLayer('polygon');
        if (map.getLayer('polygon-outline')) map.removeLayer('polygon-outline');
        if (map.getLayer('line')) map.removeLayer('line');
        if (map.getSource('polygon')) map.removeSource('polygon');
        if (map.getSource('line')) map.removeSource('line');
      }
      updateMapUI();
    }

    // Shapefile handling
    function handleShapefileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          shp(e.target.result).then(function(geojson) {
            if (!geojson || !geojson.features || geojson.features.length === 0) {
              alert('No features found in shapefile');
              return;
            }

            // Get the first feature (assume single field)
            const feature = geojson.features[0];
            
            if (feature.geometry.type === 'Polygon') {
              processPolygonCoordinates(feature.geometry.coordinates[0]);
            } else if (feature.geometry.type === 'MultiPolygon') {
              // Use the first polygon of the multipolygon
              processPolygonCoordinates(feature.geometry.coordinates[0][0]);
            } else {
              alert('Shapefile must contain Polygon or MultiPolygon geometry');
              return;
            }

            alert('Shapefile loaded successfully!');
          }).catch(function(error) {
            console.error('Error parsing shapefile:', error);
            alert('Error loading shapefile. Make sure it\'s a valid .zip with .shp, .shx, and .dbf files.');
          });
        } catch (error) {
          console.error('Error reading shapefile:', error);
          alert('Error reading shapefile');
        }
      };
      
      reader.readAsArrayBuffer(file);
    }

    function processPolygonCoordinates(coordinates) {
      // Clear existing points
      mapPoints = [];
      markersLayer.forEach(m => m.remove());
      markersLayer = [];

      // Add points from shapefile (excluding the last duplicate point)
      const points = coordinates.slice(0, -1);
      
      points.forEach(coord => {
        const [lng, lat] = coord;
        mapPoints.push([lng, lat]);
        
        // Add marker
        const el = document.createElement('div');
        el.style.width = '20px';
        el.style.height = '20px';
        el.style.borderRadius = '50%';
        el.style.backgroundColor = '#4CAF50';
        el.style.border = '3px solid white';
        el.style.boxShadow = '0 2px 4px rgba(0,0,0,0.3)';
        
        const marker = new mapboxgl.Marker(el)
          .setLngLat([lng, lat])
          .addTo(map);
        
        markersLayer.push(marker);
      });

      // Calculate bounds and fit map
      if (mapPoints.length > 0) {
        const bounds = mapPoints.reduce((bounds, coord) => {
          return bounds.extend(coord);
        }, new mapboxgl.LngLatBounds(mapPoints[0], mapPoints[0]));
        
        map.fitBounds(bounds, { padding: 50 });
      }

      updateMapUI();
      drawPolygon();
    }

    // Fields Management
    function deleteField(id) {
      if (confirm('Delete this field?')) {
        fields = fields.filter(f => f.id !== id);
        saveData();
        renderFields();
      }
    }

    function renderFields() {
      if (fields.length === 0) {
        document.getElementById('fieldsList').innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">No fields yet. Create your first field above!</p>';
        return;
      }

      document.getElementById('fieldsList').innerHTML = fields.map(f => `
        <div class="field-card">
          <div style="display: flex; justify-content: space-between; align-items: start;">
            <div>
              <h3 style="font-size: 20px; margin-bottom: 8px;">${f.name}</h3>
              <p style="color: #666;"><strong>${f.acres} acres</strong> ‚Ä¢ ${f.currentCrop}</p>
            </div>
            <button class="menu-btn" onclick="deleteField(${f.id})">üóëÔ∏è</button>
          </div>
        </div>
      `).join('');
    }

    // Activity logging functions
    function filterActivities(value) {
      const suggestions = document.getElementById('activitySuggestions');
      if (!value) {
        suggestions.classList.add('hidden');
        return;
      }

      const matches = activityTypes.filter(a => a.toLowerCase().includes(value.toLowerCase()));
      if (matches.length === 0) {
        suggestions.classList.add('hidden');
        return;
      }

      suggestions.innerHTML = matches.map(a => `
        <div class="suggestion-item" onclick="selectActivity('${a}')">${a}</div>
      `).join('');
      suggestions.classList.remove('hidden');
    }

    function selectActivity(activity) {
      document.getElementById('activityType').value = activity;
      document.getElementById('activitySuggestions').classList.add('hidden');
      document.getElementById('fieldSelectGroup').classList.remove('hidden');
      document.getElementById('activityDate').value = new Date().toISOString().split('T')[0];
      document.getElementById('dateGroup').classList.remove('hidden');
      document.getElementById('fuelGroup').classList.remove('hidden');

      const needsProduct = activity.toLowerCase().includes('application') || activity.toLowerCase().includes('spray') || activity.toLowerCase().includes('fertiliz');
      const needsSeed = activity.toLowerCase().includes('plant');
      const isHarvest = activity.toLowerCase().includes('harvest');

      document.getElementById('productGroup').classList.toggle('hidden', !needsProduct);
      document.getElementById('rateGroup').classList.toggle('hidden', !needsProduct);
      document.getElementById('seedGroup').classList.toggle('hidden', !needsSeed);
      document.getElementById('harvestGroup').classList.toggle('hidden', !isHarvest);

      if (needsProduct) {
        updateProductSelect();
        // Auto-select unit based on activity type
        setDefaultUnit(activity);
      }
    }

    function setDefaultUnit(activity) {
      const activityLower = activity.toLowerCase();
      const rateUnitSelect = document.getElementById('rateUnit');

      // Herbicides, Insecticides, Fungicides typically use oz/acre
      if (activityLower.includes('herbicide') || activityLower.includes('insecticide') || activityLower.includes('fungicide')) {
        rateUnitSelect.value = 'oz/acre';
      }
      // Fertilizers typically use lb/acre
      else if (activityLower.includes('fertilizer') || activityLower.includes('nitrogen') || activityLower.includes('phosphorus')) {
        rateUnitSelect.value = 'lb/acre';
      }
      // Default to oz/acre for other applications
      else {
        rateUnitSelect.value = 'oz/acre';
      }
    }

    function filterFields(value) {
      const suggestions = document.getElementById('fieldSuggestions');
      const matches = fields.filter(f => f.name.toLowerCase().includes(value.toLowerCase()));
      
      if (matches.length === 0) {
        suggestions.classList.add('hidden');
        return;
      }

      const isHarvest = document.getElementById('activityType').value.toLowerCase().includes('harvest');
      let html = '';
      
      if (isHarvest) {
        const totalAcres = fields.reduce((sum, f) => sum + f.acres, 0);
        html += `<div class="suggestion-item" onclick="selectField('All Fields', ${totalAcres})"><strong>All Fields</strong><br>${totalAcres} total acres</div>`;
      }

      html += matches.map(f => `
        <div class="suggestion-item" onclick="selectField('${f.name}', ${f.acres})">
          <strong>${f.name}</strong><br>${f.acres} acres ‚Ä¢ ${f.currentCrop}
        </div>
      `).join('');

      suggestions.innerHTML = html;
      suggestions.classList.remove('hidden');
    }

    function selectField(name, acres) {
      document.getElementById('fieldSelect').value = name;
      document.getElementById('fieldSelect').dataset.acres = acres;
      document.getElementById('fieldSuggestions').classList.add('hidden');
      document.getElementById('logActivityBtn').classList.remove('hidden');
      updateHarvestCalc();
    }

    function updateProductSelect() {
      const select = document.getElementById('productSelect');
      select.innerHTML = '<option value="">Select a product...</option>' + 
        inventory.map(p => `<option value="${p.name}">${p.name} (${p.amount} ${p.unit}s available)</option>`).join('');
    }

    function updateHarvestCalc() {
      const bushels = parseFloat(document.getElementById('totalBushels').value);
      const price = parseFloat(document.getElementById('pricePerBushel').value);
      const acres = parseFloat(document.getElementById('fieldSelect').dataset.acres);

      if (bushels && price && acres) {
        const revenue = bushels * price;
        const bushelsPerAcre = bushels / acres;
        const revenuePerAcre = revenue / acres;

        document.getElementById('harvestCalc').innerHTML = `
          <div><strong>Gross Revenue:</strong> $${revenue.toLocaleString()}</div>
          <div><strong>Bushels/Acre:</strong> ${bushelsPerAcre.toFixed(1)}</div>
          <div><strong>Revenue/Acre:</strong> $${revenuePerAcre.toFixed(2)}</div>
        `;
        document.getElementById('harvestCalc').style.display = 'block';
      }
    }

    document.getElementById('totalBushels')?.addEventListener('input', updateHarvestCalc);
    document.getElementById('pricePerBushel')?.addEventListener('input', updateHarvestCalc);

    function logActivity() {
      const activity = document.getElementById('activityType').value;
      const field = document.getElementById('fieldSelect').value;
      const date = document.getElementById('activityDate').value;
      const acres = parseFloat(document.getElementById('fieldSelect').dataset.acres);

      if (!activity || !field) {
        alert('Please complete all required fields');
        return;
      }

      let cost = parseFloat(document.getElementById('fuelCost').value) || 0;
      let revenue = 0;

      if (activity.toLowerCase().includes('harvest')) {
        const bushels = parseFloat(document.getElementById('totalBushels').value);
        const price = parseFloat(document.getElementById('pricePerBushel').value);
        if (bushels && price) {
          revenue = bushels * price;
        }
      }

      const product = document.getElementById('productSelect')?.value;
      if (product) {
        const rate = parseFloat(document.getElementById('applicationRate').value);
        const rateUnit = document.getElementById('rateUnit').value;
        const prod = inventory.find(p => p.name === product);
        
        if (prod && rate) {
          let amountUsed = 0;
          if (rateUnit === 'oz/acre') amountUsed = (rate * acres) / 128;
          else if (rateUnit === 'gal/acre') amountUsed = rate * acres;
          else if (rateUnit === 'lb/acre') amountUsed = rate * acres;

          cost += amountUsed * prod.costPerUnit;
          prod.amount -= amountUsed;
        }
      }

      if (activity.toLowerCase().includes('plant')) {
        const variety = document.getElementById('seedVariety').value;
        const seedPopulation = document.getElementById('seedPopulation').value;
        if (variety && field !== 'All Fields') {
          const f = fields.find(fi => fi.name === field);
          if (f) {
            f.currentCrop = activity.toLowerCase().includes('corn') ? 'Corn' :
                            activity.toLowerCase().includes('soybean') ? 'Soybeans' :
                            activity.toLowerCase().includes('wheat') ? 'Wheat' : variety;
          }
        }
      }

      // Build activity log object with all details
      const activityLog = {
        id: Date.now(),
        activity,
        field,
        date,
        cost,
        revenue
      };

      // Save application details if product was used
      if (product) {
        const rate = parseFloat(document.getElementById('applicationRate').value);
        const rateUnit = document.getElementById('rateUnit').value;
        if (rate) {
          activityLog.applicationRate = rate;
          activityLog.rateUnit = rateUnit;
          activityLog.product = product;
        }
      }

      // Save planting details
      if (activity.toLowerCase().includes('plant')) {
        const variety = document.getElementById('seedVariety').value;
        const seedPopulation = document.getElementById('seedPopulation').value;
        if (variety) activityLog.seedVariety = variety;
        if (seedPopulation) activityLog.seedPopulation = seedPopulation;
      }

      // Save harvest details
      if (activity.toLowerCase().includes('harvest')) {
        const bushels = parseFloat(document.getElementById('totalBushels').value);
        const price = parseFloat(document.getElementById('pricePerBushel').value);
        if (bushels) activityLog.bushels = bushels;
        if (price) activityLog.pricePerBushel = price;
      }

      activityLogs.push(activityLog);

      saveData(); // Save to localStorage
      alert('Activity logged successfully!');
      showScreen('dashboard');
    }

    // Inventory Management
    function showAddProduct() {
      document.getElementById('addProductForm').classList.remove('hidden');
    }

    function cancelAddProduct() {
      document.getElementById('addProductForm').classList.add('hidden');
      document.getElementById('newProductName').value = '';
      document.getElementById('newProductAmount').value = '';
      document.getElementById('newProductTotalCost').value = '';
      document.getElementById('newProductCostPerUnit').value = '';
    }

    function calcCostPerUnit() {
      const total = parseFloat(document.getElementById('newProductTotalCost').value);
      const amount = parseFloat(document.getElementById('newProductAmount').value);
      if (total && amount) {
        document.getElementById('newProductCostPerUnit').value = (total / amount).toFixed(2);
      }
    }

    function calcTotalCost() {
      const perUnit = parseFloat(document.getElementById('newProductCostPerUnit').value);
      const amount = parseFloat(document.getElementById('newProductAmount').value);
      if (perUnit && amount) {
        document.getElementById('newProductTotalCost').value = (perUnit * amount).toFixed(2);
      }
    }

    function detectCategory(name) {
      const n = name.toLowerCase();
      if (n.includes('fungicide') || n.includes('miravis')) return 'Fungicide';
      if (n.includes('herbicide') || n.includes('roundup')) return 'Herbicide';
      if (n.includes('insecticide')) return 'Insecticide';
      if (n.includes('fertilizer') || n.includes('nitrogen')) return 'Fertilizer';
      return 'Other';
    }

    function addProduct() {
      const name = document.getElementById('newProductName').value;
      const amount = parseFloat(document.getElementById('newProductAmount').value);
      const unit = document.getElementById('newProductUnit').value;
      const costPerUnit = parseFloat(document.getElementById('newProductCostPerUnit').value);

      if (name && amount && costPerUnit) {
        const category = detectCategory(name);
        const totalValue = amount * costPerUnit;

        const existing = inventory.find(p => p.name.toLowerCase() === name.toLowerCase() && p.unit === unit);
        if (existing) {
          const newAmount = existing.amount + amount;
          const newTotal = (existing.amount * existing.costPerUnit) + (amount * costPerUnit);
          existing.amount = newAmount;
          existing.costPerUnit = newTotal / newAmount;
          existing.totalValue = newAmount * existing.costPerUnit;
        } else {
          inventory.push({ id: Date.now(), name, amount, unit, costPerUnit, totalValue, category });
        }

        saveData(); // Save to localStorage
        cancelAddProduct();
        renderInventory();
      }
    }

    function deleteProduct(id) {
      if (confirm('Delete this product?')) {
        inventory = inventory.filter(p => p.id !== id);
        saveData();
        renderInventory();
      }
    }

    function renderInventory() {
      if (inventory.length === 0) {
        document.getElementById('inventoryList').innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">No products yet. Add your first product above!</p>';
        return;
      }

      document.getElementById('inventoryList').innerHTML = inventory.map(p => `
        <div class="product-card">
          <div style="display: flex; justify-content: space-between; align-items: start;">
            <div style="flex: 1;">
              <h3 style="font-size: 18px; margin-bottom: 8px;">${p.name}</h3>
              <p style="color: #666;">${p.amount.toFixed(2)} ${p.unit}s ‚Ä¢ $${p.costPerUnit.toFixed(2)}/${p.unit}</p>
              ${p.amount < 5 ? `<p style="color: #d32f2f; font-weight: 600; margin-top: 5px;">${p.amount.toFixed(2)} ${p.unit}s remaining</p>` : ''}
              <p style="color: #4CAF50; font-weight: 600; font-size: 12px; margin-top: 5px;">${p.category}</p>
            </div>
            <div style="display: flex; align-items: center; gap: 15px;">
              <div style="font-size: 18px; font-weight: 600;">$${p.totalValue.toFixed(2)}</div>
              <button class="menu-btn" onclick="deleteProduct(${p.id})">üóëÔ∏è</button>
            </div>
          </div>
        </div>
      `).join('');
    }

    // Insights
    function renderInsights() {
      const totalRevenue = activityLogs.reduce((sum, log) => sum + (log.revenue || 0), 0);
      const totalExpenses = activityLogs.reduce((sum, log) => sum + (log.cost || 0), 0);
      const netProfit = totalRevenue - totalExpenses;

      if (activityLogs.length === 0) {
        document.getElementById('insightsContent').innerHTML = '<div class="card" style="text-align: center; padding: 60px;"><p style="color: #999;">No activity data yet. Start logging activities to see insights!</p></div>';
        return;
      }

      let html = `
        <div class="card" style="background: #e8f5e9; border: 2px solid #4CAF50;">
          <h3 style="color: #2e7d32; margin-bottom: 20px;">Return on Investment</h3>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px;">
            <div>
              <div style="font-size: 14px; color: #666;">Gross Income</div>
              <div style="font-size: 32px; font-weight: 700; color: #2e7d32;">$${totalRevenue.toLocaleString()}</div>
            </div>
            <div>
              <div style="font-size: 14px; color: #666;">Total Expenses</div>
              <div style="font-size: 32px; font-weight: 700; color: #d32f2f;">$${totalExpenses.toLocaleString()}</div>
            </div>
            <div>
              <div style="font-size: 14px; color: #666;">Net Profit</div>
              <div style="font-size: 32px; font-weight: 700; color: ${netProfit >= 0 ? '#2e7d32' : '#d32f2f'};">$${netProfit.toLocaleString()}</div>
            </div>
            <div>
              <div style="font-size: 14px; color: #666;">ROI</div>
              <div style="font-size: 32px; font-weight: 700; color: ${netProfit >= 0 ? '#2e7d32' : '#d32f2f'};">${totalRevenue > 0 ? ((netProfit / totalRevenue) * 100).toFixed(1) : '0'}%</div>
            </div>
          </div>
        </div>

        <div class="card">
          <h3 style="margin-bottom: 15px;">Recent Activity Timeline</h3>
          ${activityLogs.slice(-10).reverse().map(log => `
            <div style="padding: 12px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between;">
              <div>
                <strong>${log.activity}</strong><br>
                <span style="color: #666; font-size: 14px;">${log.field} ‚Ä¢ ${new Date(log.date).toLocaleDateString()}</span>
              </div>
              <div style="text-align: right;">
                ${log.revenue > 0 ? `<div style="color: #4CAF50; font-weight: 600;">+$${log.revenue.toLocaleString()}</div>` : ''}
                ${log.cost > 0 ? `<div style="color: #d32f2f;">-$${log.cost.toFixed(2)}</div>` : ''}
              </div>
            </div>
          `).join('')}
        </div>
      `;

      document.getElementById('insightsContent').innerHTML = html;
    }

    // Pest Scouting Functions
    function initScouting() {
      if (fields.length === 0) {
        document.getElementById('scoutingFieldSelect').innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">No fields available. Please create a field first!</p>';
        return;
      }

      document.getElementById('scoutingFieldSelect').classList.remove('hidden');
      document.getElementById('scoutingMapView').classList.add('hidden');
      
      document.getElementById('scoutingFieldsList').innerHTML = fields.map(f => `
        <div class="field-card" onclick="selectFieldForScouting(${f.id})" style="cursor: pointer;">
          <h3 style="font-size: 18px; margin-bottom: 8px;">${f.name}</h3>
          <p style="color: #666;"><strong>${f.acres} acres</strong> ‚Ä¢ ${f.currentCrop}</p>
        </div>
      `).join('');
    }

    function selectFieldForScouting(fieldId) {
      currentScoutingField = fields.find(f => f.id === fieldId);
      if (!currentScoutingField) return;

      // Check if field has coordinates
      if (!currentScoutingField.coordinates || currentScoutingField.coordinates.length < 3) {
        alert('This field does not have map coordinates. Please edit the field and add boundary coordinates to use pest scouting.');
        return;
      }

      document.getElementById('scoutingFieldSelect').classList.add('hidden');
      document.getElementById('scoutingMapView').classList.remove('hidden');
      document.getElementById('scoutingFieldName').textContent = currentScoutingField.name;

      initScoutingMap();
      renderFieldCropObservations();
    }

    function initScoutingMap() {
      if (scoutingMap) {
        scoutingMap.remove();
      }

      // Get center of field
      const coords = currentScoutingField.coordinates;
      let center;

      try {
        center = turf.center(turf.polygon([coords])).geometry.coordinates;
      } catch (error) {
        console.error('Error calculating field center:', error);
        // Fallback to average of coordinates
        const avgLng = coords.reduce((sum, c) => sum + c[0], 0) / coords.length;
        const avgLat = coords.reduce((sum, c) => sum + c[1], 0) / coords.length;
        center = [avgLng, avgLat];
      }

      try {
        scoutingMap = new mapboxgl.Map({
          container: 'scoutingMap',
          style: 'mapbox://styles/mapbox/satellite-streets-v12',
          center: center,
          zoom: 15
        });

        scoutingMap.addControl(new mapboxgl.NavigationControl());

        scoutingMap.on('error', (e) => {
          console.error('Mapbox error:', e);
          alert('Error loading map. Please check your internet connection and try again.');
        });

        scoutingMap.on('load', () => {
          console.log('Scouting map loaded successfully');
        // Draw field boundary
        scoutingMap.addSource('field-boundary', {
          'type': 'geojson',
          'data': {
            'type': 'Feature',
            'geometry': {
              'type': 'Polygon',
              'coordinates': [[...coords, coords[0]]]
            }
          }
        });

        scoutingMap.addLayer({
          'id': 'field-fill',
          'type': 'fill',
          'source': 'field-boundary',
          'paint': {
            'fill-color': '#4CAF50',
            'fill-opacity': 0.1
          }
        });

        scoutingMap.addLayer({
          'id': 'field-outline',
          'type': 'line',
          'source': 'field-boundary',
          'paint': {
            'line-color': '#4CAF50',
            'line-width': 3
          }
        });

        // Fit map to field
        try {
          const bbox = turf.bbox(turf.polygon([coords]));
          scoutingMap.fitBounds(bbox, { padding: 50 });
        } catch (error) {
          console.error('Error fitting map bounds:', error);
          // Map will stay at the center zoom level
        }

        // Load existing crop markers
        loadCropMarkers();
      });
      } catch (error) {
        console.error('Error initializing scouting map:', error);
        alert('Failed to initialize map: ' + error.message + '\n\nPlease ensure:\n1. You have an internet connection\n2. The field has valid coordinates\n3. Try refreshing the page');
      }
    }

    function togglePinMode() {
      if (scoutingMode === 'pin') {
        // Exit pin mode
        scoutingMode = null;
        scoutingMap.getCanvas().style.cursor = '';
        scoutingMap.off('click', handlePinClick);
        clearTempMarkers();
      } else {
        // Enter pin mode
        if (scoutingMode === 'zone') {
          // Exit zone mode first
          toggleZoneMode();
        }
        scoutingMode = 'pin';
        tempPins = [];
        scoutingMap.getCanvas().style.cursor = 'crosshair';
        scoutingMap.on('click', handlePinClick);
      }
      updateScoutingButtons();
      updatePestControlButtons();
    }

    function handlePinClick(e) {
      const point = [e.lngLat.lng, e.lngLat.lat];
      tempPins.push(point);

      // Add visual marker
      const el = document.createElement('div');
      el.style.width = '24px';
      el.style.height = '24px';
      el.style.borderRadius = '50%';
      el.style.backgroundColor = '#FF5722';
      el.style.border = '3px solid white';
      el.style.boxShadow = '0 2px 4px rgba(0,0,0,0.3)';
      el.style.cursor = 'pointer';

      const marker = new mapboxgl.Marker(el)
        .setLngLat(point)
        .addTo(scoutingMap);

      tempPinMarkers.push(marker);
      updatePestControlButtons();
    }

    function toggleZoneMode() {
      if (scoutingMode === 'zone') {
        // Exit zone mode
        scoutingMode = null;
        scoutingMap.getCanvas().style.cursor = '';
        scoutingMap.off('click', handleZoneClick);
        clearTempMarkers();
      } else {
        // Enter zone mode
        if (scoutingMode === 'pin') {
          // Exit pin mode first
          togglePinMode();
        }
        scoutingMode = 'zone';
        zonePoints = [];
        zoneMarkers = [];
        scoutingMap.getCanvas().style.cursor = 'crosshair';
        scoutingMap.on('click', handleZoneClick);
      }
      updateScoutingButtons();
      updatePestControlButtons();
    }

    function handleZoneClick(e) {
      const point = [e.lngLat.lng, e.lngLat.lat];

      zonePoints.push(point);

      // Add larger, more visible marker
      const el = document.createElement('div');
      el.style.width = '20px';
      el.style.height = '20px';
      el.style.borderRadius = '50%';
      el.style.backgroundColor = '#FF9800';
      el.style.border = '3px solid white';
      el.style.boxShadow = '0 2px 4px rgba(0,0,0,0.3)';
      el.style.cursor = 'pointer';

      const marker = new mapboxgl.Marker(el)
        .setLngLat(point)
        .addTo(scoutingMap);

      zoneMarkers.push(marker);
      drawZonePreview();
      updatePestControlButtons();
    }

    function drawZonePreview() {
      // Remove existing layers
      if (scoutingMap.getLayer('zone-preview-outline')) {
        scoutingMap.removeLayer('zone-preview-outline');
      }
      if (scoutingMap.getLayer('zone-preview')) {
        scoutingMap.removeLayer('zone-preview');
      }
      if (scoutingMap.getSource('zone-preview')) {
        scoutingMap.removeSource('zone-preview');
      }

      if (zonePoints.length < 2) return;

      // Always create a polygon for 2+ points by closing the shape
      const coordinates = [[...zonePoints, zonePoints[0]]];

      scoutingMap.addSource('zone-preview', {
        'type': 'geojson',
        'data': {
          'type': 'Feature',
          'geometry': {
            'type': 'Polygon',
            'coordinates': coordinates
          }
        }
      });

      // Add orange fill
      scoutingMap.addLayer({
        'id': 'zone-preview',
        'type': 'fill',
        'source': 'zone-preview',
        'paint': {
          'fill-color': '#FF9800',
          'fill-opacity': 0.4
        }
      });

      // Add orange outline
      scoutingMap.addLayer({
        'id': 'zone-preview-outline',
        'type': 'line',
        'source': 'zone-preview',
        'paint': {
          'line-color': '#FF9800',
          'line-width': 3
        }
      });
    }

    function markWholeField() {
      tempCropLocation = { type: 'field', coordinates: currentScoutingField.coordinates };

      // Highlight the field
      if (scoutingMap.getLayer('field-highlight')) {
        scoutingMap.removeLayer('field-highlight');
      }
      if (scoutingMap.getSource('field-highlight')) {
        scoutingMap.removeSource('field-highlight');
      }

      scoutingMap.addSource('field-highlight', {
        'type': 'geojson',
        'data': {
          'type': 'Feature',
          'geometry': {
            'type': 'Polygon',
            'coordinates': currentScoutingField.coordinates
          }
        }
      });

      scoutingMap.addLayer({
        'id': 'field-highlight',
        'type': 'fill',
        'source': 'field-highlight',
        'paint': {
          'fill-color': '#4CAF50',
          'fill-opacity': 0.5
        }
      });

      // Auto-remove highlight after observation is logged
      showCropLogForm();
    }

    function updateScoutingButtons() {
      document.getElementById('pinModeBtn').style.background = scoutingMode === 'pin' ? '#d84315' : '#FF5722';
      document.getElementById('zoneModeBtn').style.background = scoutingMode === 'zone' ? '#EF6C00' : '#FF9800';
    }

    function updatePestControlButtons() {
      const hasPoints = (scoutingMode === 'pin' && tempPins.length > 0) ||
                       (scoutingMode === 'zone' && zonePoints.length > 0);
      const canComplete = (scoutingMode === 'pin' && tempPins.length > 0) ||
                         (scoutingMode === 'zone' && zonePoints.length >= 2); // Allow polygon with 2+ points

      document.getElementById('undoPestBtn').classList.toggle('hidden', !hasPoints);
      document.getElementById('completePestBtn').classList.toggle('hidden', !canComplete);
    }

    function undoLastPestPoint() {
      if (scoutingMode === 'pin' && tempPins.length > 0) {
        // Remove last pin
        tempPins.pop();
        const marker = tempPinMarkers.pop();
        marker.remove();
      } else if (scoutingMode === 'zone' && zonePoints.length > 0) {
        // Remove last zone point
        zonePoints.pop();
        const marker = zoneMarkers.pop();
        marker.remove();
        drawZonePreview();
      }
      updatePestControlButtons();
    }

    function completePestMarking() {
      if (scoutingMode === 'pin' && tempPins.length > 0) {
        // Save pins as multiple observations or single multi-pin observation
        tempCropLocation = { type: 'pins', coordinates: [...tempPins] };
        showCropLogForm();
      } else if (scoutingMode === 'zone' && zonePoints.length >= 2) {
        // Save zone (allow 2+ points for polygon)
        tempCropLocation = { type: 'zone', coordinates: [...zonePoints] };
        showCropLogForm();
      }
    }

    function updateObservationFields() {
      const type = document.getElementById('observationType').value;
      document.getElementById('pestFields').classList.toggle('hidden', type !== 'pest');
      document.getElementById('growthFields').classList.toggle('hidden', type !== 'growth');
      document.getElementById('standFields').classList.toggle('hidden', type !== 'stand');

      // Auto-detect crop type for growth stage if field is planted
      if (type === 'growth' && currentScoutingField) {
        const fieldCrop = currentScoutingField.currentCrop.toLowerCase();
        const cropSelect = document.getElementById('growthCropType');

        if (fieldCrop.includes('corn')) {
          cropSelect.value = 'corn';
          updateGrowthStages();
        } else if (fieldCrop.includes('soy')) {
          cropSelect.value = 'soybeans';
          updateGrowthStages();
        } else if (fieldCrop.includes('wheat')) {
          cropSelect.value = 'wheat';
          updateGrowthStages();
        }
      }
    }

    function updateGrowthStages() {
      const cropType = document.getElementById('growthCropType').value;
      const stageSelect = document.getElementById('growthStage');

      if (!cropType) {
        stageSelect.innerHTML = '<option value="">Select crop first...</option>';
        document.getElementById('growthStageInfo').style.display = 'none';
        return;
      }

      const stages = growthStages[cropType] || [];
      stageSelect.innerHTML = '<option value="">Select stage...</option>' +
        stages.map(stage => `<option value="${stage.code}">${stage.name}</option>`).join('');

      // Show description when stage is selected
      stageSelect.onchange = function() {
        const selectedCode = this.value;
        if (selectedCode) {
          const stage = stages.find(s => s.code === selectedCode);
          if (stage) {
            document.getElementById('stageDescription').innerHTML = `<strong>${stage.name}:</strong> ${stage.description}`;
            document.getElementById('growthStageInfo').style.display = 'block';
          }
        } else {
          document.getElementById('growthStageInfo').style.display = 'none';
        }
      };
    }

    function updatePestList() {
      const category = document.getElementById('pestCategory').value;
      const pestSelect = document.getElementById('pestType');

      if (!category) {
        pestSelect.innerHTML = '<option value="">Select category first...</option>';
        document.getElementById('treatmentRecommendation').style.display = 'none';
        return;
      }

      // Get crop type from field
      let cropType = 'corn'; // default
      if (currentScoutingField) {
        const fieldActivities = activityLogs.filter(log => log.field === currentScoutingField.name);
        const plantingActivity = fieldActivities.find(a => a.activity && a.activity.toLowerCase().includes('plant'));

        if (plantingActivity) {
          if (plantingActivity.activity.toLowerCase().includes('corn')) cropType = 'corn';
          else if (plantingActivity.activity.toLowerCase().includes('soybean')) cropType = 'soybeans';
          else if (plantingActivity.activity.toLowerCase().includes('wheat')) cropType = 'wheat';
        }
      }

      // Get appropriate pest list
      const pests = pestDatabase[category + 's']?.[cropType] || [];

      // Populate dropdown
      pestSelect.innerHTML = '<option value="">Select pest...</option>' +
        pests.map(pest => `<option value="${pest}">${pest}</option>`).join('');

      // Show treatment recommendation
      const treatment = pestTreatments[category];
      if (treatment) {
        document.getElementById('recommendedTreatment').textContent = treatment.treatment;
        document.getElementById('treatmentRecommendation').style.display = 'block';
        document.getElementById('treatmentRecommendation').style.borderLeftColor = treatment.color;
      }
    }

    function calculateYield() {
      const rowLength = parseFloat(document.getElementById('rowLength').value);
      const rowSpacing = parseFloat(document.getElementById('rowSpacing').value);
      const plantCount = parseFloat(document.getElementById('plantCount').value);
      const earsPerPlant = parseFloat(document.getElementById('earsPerPlant').value) || 1;
      const kernelRows = parseFloat(document.getElementById('kernelRows').value) || 16;
      const kernelsPerRow = parseFloat(document.getElementById('kernelsPerRow').value) || 30;

      if (!rowLength || !rowSpacing || !plantCount) {
        document.getElementById('yieldPrediction').style.display = 'none';
        return;
      }

      // Calculate plants per acre
      const rowsPerAcre = (43560 / (rowSpacing / 12)) / rowLength; // 43560 sq ft per acre
      const plantsPerAcre = Math.round(plantCount * rowsPerAcre);

      // Calculate yield (for corn)
      // Formula: (Plants/acre √ó Ears/plant √ó Kernel rows √ó Kernels/row) / 90,000 = Bushels/acre
      const kernelsPerAcre = plantsPerAcre * earsPerPlant * kernelRows * kernelsPerRow;
      const estimatedYield = Math.round(kernelsPerAcre / 90);

      document.getElementById('plantsPerAcre').textContent = plantsPerAcre.toLocaleString();
      document.getElementById('estimatedYield').textContent = estimatedYield.toLocaleString() + ' bu/ac';

      // Check for population loss compared to planting
      if (currentScoutingField) {
        const fieldActivities = activityLogs.filter(log => log.field === currentScoutingField.name);
        const plantingActivity = fieldActivities.find(a => a.activity && a.activity.toLowerCase().includes('plant'));

        if (plantingActivity && plantingActivity.seedPopulation) {
          const plantedPop = parseInt(plantingActivity.seedPopulation);
          const loss = plantedPop - plantsPerAcre;
          const lossPercent = ((loss / plantedPop) * 100).toFixed(1);

          document.getElementById('plantedPopulation').textContent = plantedPop.toLocaleString();
          document.getElementById('populationLoss').textContent = loss.toLocaleString();
          document.getElementById('populationLossPercent').textContent = lossPercent;
          document.getElementById('populationLossDiv').style.display = 'block';
        } else {
          document.getElementById('populationLossDiv').style.display = 'none';
        }
      } else {
        document.getElementById('populationLossDiv').style.display = 'none';
      }

      document.getElementById('yieldPrediction').style.display = 'block';
    }

    function clearTempMarkers() {
      // Clear pin markers
      tempPinMarkers.forEach(m => m.remove());
      tempPinMarkers = [];
      tempPins = [];

      // Clear zone markers
      zoneMarkers.forEach(m => m.remove());
      zoneMarkers = [];
      zonePoints = [];

      // Clear zone preview
      if (scoutingMap && scoutingMap.getLayer('zone-preview-outline')) {
        scoutingMap.removeLayer('zone-preview-outline');
      }
      if (scoutingMap && scoutingMap.getLayer('zone-preview')) {
        scoutingMap.removeLayer('zone-preview');
      }
      if (scoutingMap && scoutingMap.getSource('zone-preview')) {
        scoutingMap.removeSource('zone-preview');
      }

      updatePestControlButtons();
    }

    function showCropLogForm() {
      document.getElementById('cropLogForm').classList.remove('hidden');
      scoutingMap.getCanvas().style.cursor = '';
      updateObservationFields(); // Initialize field visibility
    }

    function cancelCropLog() {
      document.getElementById('cropLogForm').classList.add('hidden');
      document.getElementById('observationType').value = 'pest';
      document.getElementById('pestCategory').value = '';
      document.getElementById('pestType').value = '';
      document.getElementById('pestSeverity').value = '3';
      document.getElementById('growthCropType').value = '';
      document.getElementById('growthStage').value = '';
      document.getElementById('cropPhoto').value = '';
      document.getElementById('cropNotes').value = '';
      document.getElementById('rowLength').value = '';
      document.getElementById('plantCount').value = '';
      tempCropLocation = null;
      scoutingMode = null;
      updateScoutingButtons();
      clearTempMarkers();

      // Remove field highlight
      if (scoutingMap && scoutingMap.getLayer('field-highlight')) {
        scoutingMap.removeLayer('field-highlight');
      }
      if (scoutingMap && scoutingMap.getSource('field-highlight')) {
        scoutingMap.removeSource('field-highlight');
      }
    }

    function updateSeverityLabel(value) {
      const labels = ['', 'Very Low', 'Low', 'Medium', 'High', 'Very High'];
      const colors = ['', '#4CAF50', '#8BC34A', '#FF9800', '#FF5722', '#d32f2f'];
      document.getElementById('severityLabel').textContent = labels[value];
      document.getElementById('severityLabel').style.color = colors[value];
    }

    function saveCropObservation() {
      const observationType = document.getElementById('observationType').value;
      const notes = document.getElementById('cropNotes').value;
      const photoInput = document.getElementById('cropPhoto');

      let observationData = { observationType };

      if (observationType === 'pest') {
        const pestCategory = document.getElementById('pestCategory').value;
        const pestType = document.getElementById('pestType').value;
        const severity = parseInt(document.getElementById('pestSeverity').value);

        if (!pestCategory || !pestType) {
          alert('Please select pest category and type');
          return;
        }

        observationData.pestCategory = pestCategory;
        observationData.pestType = pestType;
        observationData.severity = severity;

        // Add treatment recommendation
        const treatment = pestTreatments[pestCategory];
        if (treatment) {
          observationData.recommendedTreatment = treatment.treatment;
        }
      } else if (observationType === 'growth') {
        const cropType = document.getElementById('growthCropType').value;
        const growthStage = document.getElementById('growthStage').value;

        if (!cropType || !growthStage) {
          alert('Please select crop type and growth stage');
          return;
        }

        observationData.cropType = cropType;
        observationData.growthStage = growthStage;

        const stages = growthStages[cropType] || [];
        const stageInfo = stages.find(s => s.code === growthStage);
        if (stageInfo) {
          observationData.growthStageName = stageInfo.name;
          observationData.growthStageDescription = stageInfo.description;
        }

        // Update field's current growth stage
        if (currentScoutingField) {
          const field = fields.find(f => f.id === currentScoutingField.id);
          if (field) {
            field.latestGrowthStage = growthStage;
            field.latestGrowthStageName = stageInfo ? stageInfo.name : growthStage;
            saveData();
          }
        }
      } else if (observationType === 'stand') {
        const rowLength = parseFloat(document.getElementById('rowLength').value);
        const plantCount = parseFloat(document.getElementById('plantCount').value);

        if (!rowLength || !plantCount) {
          alert('Please enter row length and plant count');
          return;
        }

        observationData.rowLength = rowLength;
        observationData.rowSpacing = parseFloat(document.getElementById('rowSpacing').value);
        observationData.plantCount = plantCount;
        observationData.earsPerPlant = parseFloat(document.getElementById('earsPerPlant').value);
        observationData.kernelRows = parseFloat(document.getElementById('kernelRows').value);
        observationData.kernelsPerRow = parseFloat(document.getElementById('kernelsPerRow').value);
        observationData.plantsPerAcre = document.getElementById('plantsPerAcre').textContent;
        observationData.estimatedYield = document.getElementById('estimatedYield').textContent;
      }

      // Handle multiple pins - create separate observation for each pin
      if (tempCropLocation.type === 'pins') {
        const timestamp = new Date().toISOString();
        const baseId = Date.now();

        if (photoInput.files && photoInput.files[0]) {
          const reader = new FileReader();
          reader.onload = function(e) {
            const photoData = e.target.result;
            tempCropLocation.coordinates.forEach((pinCoords, index) => {
              cropObservations.push({
                id: baseId + index,
                fieldId: currentScoutingField.id,
                fieldName: currentScoutingField.name,
                ...observationData,
                notes: notes,
                location: { type: 'pin', coordinates: pinCoords },
                timestamp: timestamp,
                photo: photoData
              });
            });
            finalizeCropObservation();
          };
          reader.readAsDataURL(photoInput.files[0]);
        } else {
          tempCropLocation.coordinates.forEach((pinCoords, index) => {
            cropObservations.push({
              id: baseId + index,
              fieldId: currentScoutingField.id,
              fieldName: currentScoutingField.name,
              ...observationData,
              notes: notes,
              location: { type: 'pin', coordinates: pinCoords },
              timestamp: timestamp,
              photo: null
            });
          });
          finalizeCropObservation();
        }
      } else {
        // Single observation (zone or whole field)
        const observation = {
          id: Date.now(),
          fieldId: currentScoutingField.id,
          fieldName: currentScoutingField.name,
          ...observationData,
          notes: notes,
          location: tempCropLocation,
          timestamp: new Date().toISOString(),
          photo: null
        };

        // Handle photo if uploaded
        if (photoInput.files && photoInput.files[0]) {
          const reader = new FileReader();
          reader.onload = function(e) {
            observation.photo = e.target.result;
            cropObservations.push(observation);
            finalizeCropObservation();
          };
          reader.readAsDataURL(photoInput.files[0]);
        } else {
          cropObservations.push(observation);
          finalizeCropObservation();
        }
      }
    }

    function finalizeCropObservation() {
      const count = tempCropLocation && tempCropLocation.type === 'pins'
        ? tempCropLocation.coordinates.length
        : 1;

      saveData(); // Save to localStorage
      clearTempMarkers(); // Clear temp markers before canceling
      cancelCropLog();
      loadCropMarkers();
      renderFieldCropObservations();
      updateHeatMap(); // Update heat map with new observation

      const message = count > 1
        ? `${count} crop observations saved!`
        : 'Crop observation saved!';
      alert(message);
    }

    function loadCropMarkers() {
      const fieldObs = cropObservations.filter(obs => obs.fieldId === currentScoutingField.id);
      
      fieldObs.forEach(obs => {
        const severityColor = obs.severity <= 2 ? '#4CAF50' : obs.severity <= 3 ? '#FF9800' : '#f44336';
        
        if (obs.location.type === 'pin') {
          const el = document.createElement('div');
          el.style.width = '24px';
          el.style.height = '24px';
          el.style.borderRadius = '50%';
          el.style.backgroundColor = severityColor;
          el.style.border = '3px solid white';
          el.style.boxShadow = '0 2px 4px rgba(0,0,0,0.3)';
          el.style.cursor = 'pointer';
          
          const marker = new mapboxgl.Marker(el)
            .setLngLat(obs.location.coordinates)
            .setPopup(new mapboxgl.Popup().setHTML(`
              <strong>${obs.pestType}</strong><br>
              Severity: ${obs.severity}/5<br>
              ${obs.notes ? obs.notes : ''}
            `))
            .addTo(scoutingMap);
        } else if (obs.location.type === 'zone') {
          const layerId = `zone-${obs.id}`;
          
          if (!scoutingMap.getSource(layerId)) {
            scoutingMap.addSource(layerId, {
              'type': 'geojson',
              'data': {
                'type': 'Feature',
                'geometry': {
                  'type': 'Polygon',
                  'coordinates': [[...obs.location.coordinates, obs.location.coordinates[0]]]
                }
              }
            });

            scoutingMap.addLayer({
              'id': layerId,
              'type': 'fill',
              'source': layerId,
              'paint': {
                'fill-color': severityColor,
                'fill-opacity': 0.4
              }
            });
          }
        }
      });
    }

    function renderFieldCropObservations() {
      const fieldObs = cropObservations.filter(obs => obs.fieldId === currentScoutingField.id);

      if (fieldObs.length === 0) {
        document.getElementById('cropObservationsList').innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No observations yet for this field</p>';
        return;
      }

      document.getElementById('cropObservationsList').innerHTML = fieldObs.reverse().map(obs => {
        const severityColor = obs.severity <= 2 ? '#4CAF50' : obs.severity <= 3 ? '#FF9800' : '#f44336';
        const severityText = obs.severity <= 2 ? 'Low' : obs.severity <= 3 ? 'Medium' : 'High';
        const locationText = obs.location.type === 'pin' ? 'Point' : obs.location.type === 'zone' ? 'Zone' : 'Whole Field';
        
        return `
          <div style="padding: 15px; border: 1px solid #e0e0e0; border-radius: 8px; margin-bottom: 10px;">
            ${obs.photo ? `<img src="${obs.photo}" style="width: 100%; height: 150px; object-fit: cover; border-radius: 6px; margin-bottom: 10px;">` : ''}
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
              <div>
                <strong style="font-size: 16px;">${obs.pestType}</strong>
                <div style="font-size: 12px; color: #666; margin-top: 4px;">${locationText} ‚Ä¢ ${new Date(obs.timestamp).toLocaleString()}</div>
              </div>
              <div style="padding: 4px 12px; background: ${severityColor}; color: white; border-radius: 20px; font-size: 12px; font-weight: 600;">${severityText}</div>
            </div>
            ${obs.notes ? `<div style="font-size: 14px; color: #555; margin-top: 8px;">${obs.notes}</div>` : ''}
          </div>
        `;
      }).join('');
    }

    function backToFieldSelection() {
      document.getElementById('scoutingMapView').classList.add('hidden');
      document.getElementById('scoutingFieldSelect').classList.remove('hidden');
      currentScoutingField = null;
      heatMapVisible = false;
      if (scoutingMap) {
        scoutingMap.remove();
        scoutingMap = null;
      }
    }

    // Heat Map Functions
    function toggleHeatMap() {
      heatMapVisible = !heatMapVisible;
      document.getElementById('heatMapBtn').style.background = heatMapVisible ? '#7B1FA2' : '#9C27B0';

      if (heatMapVisible) {
        addHeatMapLayer();
      } else {
        removeHeatMapLayer();
      }
    }

    function generateHeatMapData() {
      const fieldObs = cropObservations.filter(obs => obs.fieldId === currentScoutingField.id);

      const features = [];

      fieldObs.forEach(obs => {
        let point = null;

        if (obs.location.type === 'pin') {
          // Use pin coordinates directly
          point = obs.location.coordinates;
        } else if (obs.location.type === 'zone') {
          // Calculate centroid of zone polygon
          const polygon = turf.polygon([[...obs.location.coordinates, obs.location.coordinates[0]]]);
          point = turf.centroid(polygon).geometry.coordinates;
        } else if (obs.location.type === 'field') {
          // Calculate centroid of field
          const polygon = turf.polygon([[...obs.location.coordinates, obs.location.coordinates[0]]]);
          point = turf.centroid(polygon).geometry.coordinates;
        }

        if (point) {
          features.push({
            type: 'Feature',
            geometry: {
              type: 'Point',
              coordinates: point
            },
            properties: {
              intensity: obs.severity // Use severity (1-5) as intensity weight
            }
          });
        }
      });

      return {
        type: 'FeatureCollection',
        features: features
      };
    }

    function addHeatMapLayer() {
      if (!scoutingMap) return;

      const heatMapData = generateHeatMapData();

      // Remove existing heat map if present
      if (scoutingMap.getLayer('pest-heatmap')) {
        scoutingMap.removeLayer('pest-heatmap');
      }
      if (scoutingMap.getSource('pest-heatmap')) {
        scoutingMap.removeSource('pest-heatmap');
      }

      // Add heat map source
      scoutingMap.addSource('pest-heatmap', {
        type: 'geojson',
        data: heatMapData
      });

      // Add heat map layer
      scoutingMap.addLayer({
        id: 'pest-heatmap',
        type: 'heatmap',
        source: 'pest-heatmap',
        paint: {
          // Increase weight as severity increases
          'heatmap-weight': [
            'interpolate',
            ['linear'],
            ['get', 'intensity'],
            1, 0.2,  // Low severity = low weight
            5, 1.0   // High severity = high weight
          ],
          // Increase intensity as zoom level increases
          'heatmap-intensity': [
            'interpolate',
            ['linear'],
            ['zoom'],
            0, 1,
            15, 3
          ],
          // Color ramp for heatmap - infrared spectrum (black-red-orange-yellow-white)
          'heatmap-color': [
            'interpolate',
            ['linear'],
            ['heatmap-density'],
            0, 'rgba(0,0,0,0)',          // Transparent
            0.2, 'rgb(0,0,0)',            // Black
            0.4, 'rgb(139,0,0)',          // Dark red
            0.6, 'rgb(255,69,0)',         // Red-orange
            0.8, 'rgb(255,165,0)',        // Orange
            0.9, 'rgb(255,255,0)',        // Yellow
            1, 'rgb(255,255,255)'         // White (hottest)
          ],
          // Adjust radius based on zoom level
          'heatmap-radius': [
            'interpolate',
            ['linear'],
            ['zoom'],
            0, 20,
            15, 40,
            18, 60
          ],
          // Transition from heatmap to circle layer at high zoom
          'heatmap-opacity': [
            'interpolate',
            ['linear'],
            ['zoom'],
            14, 1,
            16, 0.5
          ]
        }
      }, 'field-outline'); // Add below field outline so it's visible
    }

    function removeHeatMapLayer() {
      if (!scoutingMap) return;

      if (scoutingMap.getLayer('pest-heatmap')) {
        scoutingMap.removeLayer('pest-heatmap');
      }
      if (scoutingMap.getSource('pest-heatmap')) {
        scoutingMap.removeSource('pest-heatmap');
      }
    }

    function updateHeatMap() {
      if (heatMapVisible && scoutingMap && scoutingMap.getSource('pest-heatmap')) {
        const heatMapData = generateHeatMapData();
        scoutingMap.getSource('pest-heatmap').setData(heatMapData);
      }
    }

    // Initialize
    loadData(); // Load saved data from localStorage
    showScreen('login');
  </script>
</body>
</html>